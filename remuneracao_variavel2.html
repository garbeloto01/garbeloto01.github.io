<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Remuneração Variável</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --primary-red: #d90000;
            --primary-red-dark: #b30000;
            --primary-black: #222222;
            --primary-black-dark: #000000;
            --primary-blue: #0f62fe;
            --primary-blue-dark: #0353e9;
            --primary-green: #22c55e;
            --primary-green-dark: #16a34a;
            --primary-orange: #f97316;
            --primary-orange-dark: #ea580c;
        }
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        
        /* Inputs mais visíveis (Correção 2) */
        input, select {
            border-color: #6b7280 !important; /* gray-500 */
            border-width: 1px !important;
        }
        input:focus, select:focus {
            border-color: var(--primary-red) !important;
            border-width: 2px !important;
        }

        .modal {
            display: none; 
            position: fixed; 
            z-index: 100; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgba(0,0,0,0.5); 
            padding-top: 60px; 
        }
        .modal-content {
            background-color: #ffffff; 
            margin: 5% auto; 
            padding: 24px; 
            border: 1px solid #888; 
            width: 90%; 
            max-width: 500px; 
            border-radius: 12px; 
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover, .close:focus { color: #000; text-decoration: none; cursor: pointer; }
        
        #login-screen { background-color: var(--primary-black); }
        
        #historyTable th, #historyTable td { border: 1px solid #e2e8f0; padding: 8px 12px; white-space: nowrap; }
        #historyTable th { background-color: #f8fafc; cursor: pointer; user-select: none; position: sticky; top: 0; }
        #historyTable th:hover { background-color: #f1f5f9; }
        #historyTable .sort-arrow { display: inline-block; margin-left: 5px; opacity: 0.3; }
        #historyTable .sort-arrow.active { opacity: 1; }

        .tab-button { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-button.active { border-bottom: 2px solid var(--primary-red); color: var(--primary-red); font-weight: 600; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        #indices-container.grid-layout { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; align-items: start; }
        #indices-container.grid-layout .index-item { display: flex; flex-direction: column; }
        
        /* Correção 3: Rótulo não cortado */
        #indices-container.grid-layout .index-item label { 
            font-size: 0.875rem; 
            color: #111827; /* Mais escuro para legibilidade */
            font-weight: 600;
            margin-bottom: 4px; 
            white-space: normal; /* Permite quebra de linha */
            overflow: visible; 
            text-overflow: clip; 
            max-width: 100%; 
            line-height: 1.2;
        }
        #indices-container.grid-layout .index-item input { width: 100%; }
    </style>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100">

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-lg shadow-xl border border-gray-200 relative">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login - Remuneração Variável</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150">Entrar</button>
                <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden">Usuário ou senha inválidos.</p>
            </form>

            <!-- Botão de Cadastro Master -->
            <div id="master-register-container" class="mt-6 text-center hidden border-t pt-4">
                <p class="text-sm text-gray-600 mb-2">Primeiro acesso?</p>
                <button type="button" id="btn-register-master" class="text-sm text-red-600 font-bold hover:underline">CADASTRAR USUÁRIO MASTER</button>
            </div>
        </div>
    </div>
    
    <!-- Conteúdo Principal -->
    <div id="app-content" class="hidden">
        <header class="bg-white shadow-md border-b border-gray-200">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>
                    <h1 class="text-xl font-bold text-gray-800">Ferramenta de Remuneração Variável</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-view-launch" class="text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m0 8c-1.11 0-2.08-.402-2.599-1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M12 15c-1.11 0-2.08-.402-2.599-1M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v1.522c0 .414.336.75.75.75h14.5a.75.75 0 00.75-.75V7" /></svg>
                        <span>Lançamento</span>
                    </button>
                    <button id="btn-view-admin" class="hidden text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Painel de Gestão</span>
                    </button>
                    <button id="btn-logout" class="text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg>
                        <span>Sair</span>
                    </button>
                </div>
            </div>
        </header>

        <div class="container mx-auto p-4 max-w-7xl">
            <div id="admin-controls" class="hidden bg-white p-4 rounded-lg shadow border border-gray-200 mb-6">
                <div class="flex flex-wrap justify-end items-center gap-3">
                    <p id="user-id-log" class="hidden text-sm font-medium text-gray-600 mr-auto">Seu ID de Usuário (para log): <span class="font-mono bg-gray-200 text-gray-800 px-2 py-0.5 rounded-md" id="current-user-id-display">Carregando...</span></p>
                    
                    <button type="button" id="btn-open-supervisor-modal" class="hidden flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span>+ Cadastrar Gestão</span>
                    </button>
                    <button type="button" id="btn-open-sector-modal" class="hidden flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-150">
                         <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        <span>+ Cadastrar Setor</span>
                    </button>
                    <button type="button" id="btn-open-employee-modal" class="hidden flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                        <span>+ Cadastrar Colaborador</span>
                    </button>
                    <button type="button" id="btn-manage-sector-indices" class="hidden flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-600 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.072-.267-2.09-.75-3.042z" /></svg>
                        <span>Gerenciar Metas</span>
                    </button>
                </div>
            </div>

            <!-- Visão: Lançamento -->
            <div id="view-launch" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow border border-gray-200 h-fit">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Novo Lançamento</h2>
                    <form id="launch-form">
                        <div class="space-y-5">
                            <div>
                                <label for="month-ref" class="block text-sm font-medium text-gray-700">Mês de Referência (Filtro)</label>
                                <input type="month" id="month-ref" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            </div>
                            <div id="sector-filter-container" class="hidden">
                                <label for="sector-filter" class="block text-sm font-medium text-gray-700">Filtrar por Setor</label>
                                <select id="sector-filter" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white">
                                    <option value="all">Todos os Setores</option>
                                </select>
                            </div>
                            <div>
                                <label for="base-value" class="block text-sm font-medium text-gray-700">Valor Base Variável (R$)</label>
                                <div class="mt-1 flex gap-2">
                                    <input type="number" id="base-value" placeholder="Ex: 1000.00" class="flex-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                                    <button type="button" id="btn-save-base-value" class="hidden bg-green-600 text-white px-5 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-150">Salvar</button>
                                </div>
                                 <p id="base-value-loading" class="text-sm text-gray-500 mt-1 hidden">Carregando valor...</p>
                            </div>
                            <div id="supervisor-launch-fields" class="hidden space-y-5">
                                <hr>
                                <div>
                                    <label for="employee-select" class="block text-sm font-medium text-gray-700">Colaborador</label>
                                    <select id="employee-select" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white">
                                        <option value="">-- Selecione um colaborador --</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Insira as pontuações</label>
                                    <div id="indices-container" class="mt-2 p-4 bg-gray-50 border border-gray-200 rounded-md min-h-[100px] flex items-center justify-center">
                                        <p class="text-sm text-gray-500">Selecione um colaborador para ver os índices de pontuação.</p>
                                    </div>
                                </div>
                                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                                    <p class="text-sm font-medium text-blue-700">Total Variável Calculado:</p>
                                    <p id="total-calculated" class="text-3xl font-bold text-red-600 mt-1">R$ 0,00</p>
                                </div>
                                <button type="submit" id="btn-submit-launch" class="w-full bg-red-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 text-lg">Lançar Remuneração</button>
                                <button type="button" id="btn-cancel-edit" class="hidden w-full bg-gray-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-gray-700 transition duration-150">Cancelar Edição</button>
                            </div>
                        </div>
                    </form>
                </div>

                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Histórico de Lançamentos</h2>
                        <button id="btn-download-csv" class="flex items-center gap-2 bg-white text-gray-700 px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-50 transition duration-150 text-sm">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            <span>Download CSV</span>
                        </button>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="historyTable" class="min-w-full divide-y divide-gray-200 border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th data-sort="monthRef" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês Ref. <span class="sort-arrow"></span></th>
                                    <th data-sort="employeeName" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colaborador <span class="sort-arrow"></span></th>
                                    <th data-sort="sectorName" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor <span class="sort-arrow"></span></th>
                                    <th data-sort="baseValue" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base (R$) <span class="sort-arrow"></span></th>
                                    <th data-sort="totalValue" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (R$) <span class="sort-arrow"></span></th>
                                    <th data-sort="createdAt" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lançado Em <span class="sort-arrow"></span></th>
                                    <th data-sort="details" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalhes <span class="sort-arrow"></span></th>
                                    <th id="history-action-header" data-sort="action" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação <span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="history-loading"><td colspan="8" class="text-center py-6 text-gray-500">Carregando histórico...</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visão: Painel de Gestão -->
            <div id="view-admin" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Painel de Gestão (Admin Master)</h2>
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex -mb-px" aria-label="Tabs">
                            <button class="tab-button active" data-tab="supervisors">Supervisores</button>
                            <button class="tab-button" data-tab="sectors">Setores</button>
                            <button class="tab-button" data-tab="employees">Colaboradores</button>
                        </nav>
                    </div>
                    <div>
                        <div id="tab-supervisors" class="tab-content active">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário (Login)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supervisors-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="tab-sectors" class="tab-content">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Índices Definidos</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sectors-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                        <div id="tab-employees" class="tab-content">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-table-body" class="bg-white divide-y divide-gray-200"></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modais -->
    <div id="master-registration-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-master-reg">&times;</span>
            <h2 class="text-xl font-bold mb-6 text-red-600">Cadastro de Usuário Master</h2>
            <p class="text-sm text-gray-600 mb-4">Defina o usuário e senha para o acesso administrativo principal. <strong>Isso só pode ser feito uma vez.</strong></p>
            <form id="master-registration-form">
                <div class="space-y-4">
                    <div>
                        <label for="reg-master-username" class="block text-sm font-medium text-gray-700">Usuário</label>
                        <input type="text" id="reg-master-username" value="admin" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="reg-master-password" class="block text-sm font-medium text-gray-700">Senha</label>
                        <input type="password" id="reg-master-password" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required minlength="6">
                    </div>
                    <div>
                        <label for="reg-master-confirm" class="block text-sm font-medium text-gray-700">Confirmar Senha</label>
                        <input type="password" id="reg-master-confirm" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required minlength="6">
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-master-reg" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">Salvar Master</button>
                </div>
            </form>
        </div>
    </div>

    <div id="supervisor-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-supervisor-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="supervisor-modal-title">Cadastrar Novo Supervisor</h2>
            <form id="supervisor-form">
                <input type="hidden" id="edit-supervisor-id">
                <div class="space-y-4">
                    <div>
                        <label for="supervisor-name" class="block text-sm font-medium text-gray-700">Nome do Supervisor</label>
                        <input type="text" id="supervisor-name" placeholder="Ex: Maria Gestora" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="supervisor-sector" class="block text-sm font-medium text-gray-700">Setor do Supervisor</label>
                        <div class="flex gap-2 items-center">
                            <select id="supervisor-sector" class="flex-1 mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white" required>
                                <option value="">-- Selecione um setor --</option>
                            </select>
                        </div>
                    </div>
                    <div>
                        <label for="supervisor-username" class="block text-sm font-medium text-gray-700">Usuário (para login)</label>
                        <input type="text" id="supervisor-username" placeholder="Ex: maria.gestora" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="supervisor-password" class="block text-sm font-medium text-gray-700">Senha (para login)</label>
                        <input type="password" id="supervisor-password" placeholder="Mínimo 6 caracteres" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        <div class="flex items-center mt-2">
                            <input type="checkbox" id="show-password" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                            <label for="show-password" class="ml-2 block text-sm text-gray-900">Mostrar senha</label>
                        </div>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-supervisor-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">Salvar Supervisor</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sector-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-sector-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="sector-modal-title">Cadastrar Novo Setor</h2>
            <form id="sector-form">
                <input type="hidden" id="edit-sector-id">
                <div class="space-y-4">
                    <div>
                        <label for="sector-name" class="block text-sm font-medium text-gray-700">Nome do Setor</label>
                        <input type="text" id="sector-name" placeholder="Ex: Vendas" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-sector-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button type="submit" id="btn-submit-sector-form" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">Salvar Setor</button>
                </div>
            </form>
        </div>
    </div>

    <div id="sector-indices-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-sector-indices-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6">Gerenciar Metas (Índices)</h2>
            <form id="sector-indices-form">
                <input type="hidden" id="edit-indices-sector-id">
                <div class="space-y-4">
                    <div>
                        <label for="sector-indices-name" class="block text-sm font-medium text-gray-700">Setor</label>
                        <input type="text" id="sector-indices-name" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm bg-gray-100" readonly>
                    </div>
                    <hr>
                    <label class="block text-sm font-medium text-gray-700">Defina os Índices:</label>
                    <div id="indices-list" class="space-y-3 max-h-60 overflow-y-auto pr-2"></div>
                    <button type="button" id="add-index-field" class="text-sm text-red-600 font-semibold hover:text-red-800">+ Adicionar Índice</button>
                    <div class="flex justify-end items-center mt-4 pt-4 border-t">
                        <span id="indices-total-percentage" class="text-lg font-bold text-gray-800">Total: 0%</span>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-sector-indices-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button type="submit" id="btn-submit-indices-form" class.disabled="true" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150 disabled:opacity-50 disabled:cursor-not-allowed">Salvar Índices</button>
                </div>
            </form>
        </div>
    </div>

    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-employee-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="employee-modal-title">Cadastrar Novo Colaborador</h2>
            <form id="employee-form">
                <input type="hidden" id="edit-employee-id">
                <div class="space-y-4">
                    <div>
                        <label for="employee-name" class="block text-sm font-medium text-gray-700">Nome do Colaborador</label>
                        <input type="text" id="employee-name" placeholder="Ex: João da Silva" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="employee-sector" class="block text-sm font-medium text-gray-700">Setor do Colaborador</label>
                        <select id="employee-sector" class="mt-1 w-full px-3 py-2 border border-gray-400 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white" required>
                            <option value="">-- Selecione um setor --</option>
                        </select>
                    </div>
                </div>
                <div class="flex justify-end gap-3 mt-6">
                    <button type="button" id="cancel-employee-modal" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">Salvar Colaborador</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-gray-900">Confirmar Exclusão</h2>
            <p class="text-gray-600 mt-4 mb-6" id="delete-confirm-message">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btn-cancel-delete" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Cancelar</button>
                <button type="button" id="btn-confirm-delete" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">Excluir</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-gray-900" id="alert-title">Aviso</h2>
            <p class="text-gray-600 mt-4 mb-6" id="alert-message">Mensagem de aviso.</p>
            <div class="flex justify-end">
                <button type="button" id="btn-close-alert" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">OK</button>
            </div>
        </div>
    </div>

    <div id="vacation-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold text-gray-900">Status do Colaborador</h2>
            <p class="text-gray-600 mt-4 mb-6" id="vacation-message">O colaborador [Nome] está ou esteve de férias neste mês de referência?</p>
            <div class="flex justify-end gap-3">
                <button type="button" id="btn-vacation-no" class="bg-gray-200 text-gray-800 px-4 py-2 rounded-md font-semibold hover:bg-gray-300 transition duration-150">Não (Lançar Notas)</button>
                <button type="button" id="btn-vacation-yes" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-150">Sim (Lançar Férias R$ 0,00)</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, addDoc, setDoc, updateDoc, deleteDoc, onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCUf800FNv--emagtwh5YevSPqFtk7Miiw",
            authDomain: "remuneracao-equipe.firebaseapp.com",
            projectId: "remuneracao-equipe",
            storageBucket: "remuneracao-equipe.firebasestorage.app",
            messagingSenderId: "1070188778724",
            appId: "1:1070188778724:web:684e19b2259a99b17288f1"
        };
        
        const appId = 'remuneracao';
        let db, auth;
        let currentUserId = null; 
        let currentSupervisorId = null; 
        let currentSupervisorSectorId = null;
        let isMaster = false;
        let isSupervisor = false;
        let isRhUser = false;
        let currentEditingLaunchId = null; 
        let globalSectors = [];
        let globalEmployees = [];
        let globalSupervisors = [];
        let globalHistory = []; 
        let currentHistorySort = { column: 'createdAt', direction: 'desc' };
        
        async function digestMessage(message) {
            if (window.crypto && window.crypto.subtle) {
                try {
                    const msgUint8 = new TextEncoder().encode(message);
                    const hashBuffer = await crypto.subtle.digest('SHA-256', msgUint8);
                    const hashArray = Array.from(new Uint8Array(hashBuffer));
                    return hashArray.map((b) => b.toString(16).padStart(2, '0')).join('');
                } catch (e) { return simpleHashFallback(message); }
            } else { return simpleHashFallback(message); }
        }

        function simpleHashFallback(str) {
            let hash = 0;
            if (str.length === 0) return hash.toString();
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash |= 0;
            }
            return "local_" + hash.toString(16);
        }

        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const loginUsername = document.getElementById('login-username');
        const loginPassword = document.getElementById('login-password');
        const loginError = document.getElementById('login-error');
        const btnLogout = document.getElementById('btn-logout');
        
        const masterRegisterContainer = document.getElementById('master-register-container');
        const btnRegisterMaster = document.getElementById('btn-register-master');
        const masterRegistrationModal = document.getElementById('master-registration-modal');
        const masterRegistrationForm = document.getElementById('master-registration-form');
        const regMasterUsername = document.getElementById('reg-master-username');
        const regMasterPassword = document.getElementById('reg-master-password');
        const regMasterConfirm = document.getElementById('reg-master-confirm');
        const cancelMasterReg = document.getElementById('cancel-master-reg');
        const closeMasterReg = document.getElementById('close-master-reg');

        const userIdLog = document.getElementById('user-id-log');
        const currentUserIdDisplay = document.getElementById('current-user-id-display');
        const adminControls = document.getElementById('admin-controls');
        
        const btnViewLaunch = document.getElementById('btn-view-launch');
        const btnViewAdmin = document.getElementById('btn-view-admin');
        const viewLaunch = document.getElementById('view-launch');
        const viewAdmin = document.getElementById('view-admin');

        const btnOpenSupervisorModal = document.getElementById('btn-open-supervisor-modal');
        const btnOpenSectorModal = document.getElementById('btn-open-sector-modal');
        const btnOpenEmployeeModal = document.getElementById('btn-open-employee-modal');
        const btnManageSectorIndices = document.getElementById('btn-manage-sector-indices');

        const launchForm = document.getElementById('launch-form');
        const monthRefInput = document.getElementById('month-ref');
        const sectorFilterContainer = document.getElementById('sector-filter-container');
        const sectorFilterSelect = document.getElementById('sector-filter');
        const baseValueInput = document.getElementById('base-value');
        const btnSaveBaseValue = document.getElementById('btn-save-base-value');
        const baseValueLoading = document.getElementById('base-value-loading');
        
        const supervisorLaunchFields = document.getElementById('supervisor-launch-fields');
        const employeeSelect = document.getElementById('employee-select');
        const indicesContainer = document.getElementById('indices-container');
        const totalCalculated = document.getElementById('total-calculated');
        const btnSubmitLaunch = document.getElementById('btn-submit-launch');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');

        const historyTable = document.getElementById('historyTable');
        const historyTableBody = document.getElementById('history-table-body');
        const historyLoading = document.getElementById('history-loading');
        const btnDownloadCSV = document.getElementById('btn-download-csv');
        
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        const supervisorsTableBody = document.getElementById('supervisors-table-body');
        const sectorsTableBody = document.getElementById('sectors-table-body');
        const employeesTableBody = document.getElementById('employees-table-body');

        const supervisorModal = document.getElementById('supervisor-modal');
        const supervisorForm = document.getElementById('supervisor-form');
        const supervisorModalTitle = document.getElementById('supervisor-modal-title');
        const editSupervisorId = document.getElementById('edit-supervisor-id');
        const supervisorName = document.getElementById('supervisor-name');
        const supervisorSector = document.getElementById('supervisor-sector');
        const supervisorUsername = document.getElementById('supervisor-username');
        const supervisorPassword = document.getElementById('supervisor-password');
        const showPassword = document.getElementById('show-password');
        const closeSupervisorModal = document.getElementById('close-supervisor-modal');
        const cancelSupervisorModal = document.getElementById('cancel-supervisor-modal');
        
        const sectorModal = document.getElementById('sector-modal');
        const sectorForm = document.getElementById('sector-form');
        const sectorModalTitle = document.getElementById('sector-modal-title');
        const editSectorId = document.getElementById('edit-sector-id');
        const sectorName = document.getElementById('sector-name');
        const closeSectorModal = document.getElementById('close-sector-modal');
        const cancelSectorModal = document.getElementById('cancel-sector-modal');
        const btnSubmitSectorForm = document.getElementById('btn-submit-sector-form');

        const sectorIndicesModal = document.getElementById('sector-indices-modal');
        const sectorIndicesForm = document.getElementById('sector-indices-form');
        const editIndicesSectorId = document.getElementById('edit-indices-sector-id');
        const sectorIndicesName = document.getElementById('sector-indices-name');
        const indicesList = document.getElementById('indices-list');
        const addIndexField = document.getElementById('add-index-field');
        const indicesTotalPercentage = document.getElementById('indices-total-percentage');
        const btnSubmitIndicesForm = document.getElementById('btn-submit-indices-form');
        const closeSectorIndicesModal = document.getElementById('close-sector-indices-modal');
        const cancelSectorIndicesModal = document.getElementById('cancel-sector-indices-modal');

        const employeeModal = document.getElementById('employee-modal');
        const employeeForm = document.getElementById('employee-form');
        const employeeModalTitle = document.getElementById('employee-modal-title');
        const editEmployeeId = document.getElementById('edit-employee-id');
        const employeeName = document.getElementById('employee-name');
        const employeeSector = document.getElementById('employee-sector');
        const closeEmployeeModal = document.getElementById('close-employee-modal');
        const cancelEmployeeModal = document.getElementById('cancel-employee-modal');

        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const btnCancelDelete = document.getElementById('btn-cancel-delete');
        const btnConfirmDelete = document.getElementById('btn-confirm-delete');
        
        const alertModal = document.getElementById('alert-modal');
        const alertTitle = document.getElementById('alert-title');
        const alertMessage = document.getElementById('alert-message');
        const btnCloseAlert = document.getElementById('btn-close-alert');

        const vacationModal = document.getElementById('vacation-modal');
        const vacationMessage = document.getElementById('vacation-message');
        const btnVacationNo = document.getElementById('btn-vacation-no');
        const btnVacationYes = document.getElementById('btn-vacation-yes');
        let vacationEmployee = null; 

        const getBasePath = () => doc(db, 'artifacts', appId);
        const getSupervisorsCollection = () => collection(getBasePath(), 'supervisors');
        const getSectorsCollection = () => collection(getBasePath(), 'sectors');
        const getEmployeesCollection = () => collection(getBasePath(), 'employees');
        const getLaunchesCollection = () => collection(getBasePath(), 'launches');
        const getBaseValuesCollection = () => collection(getBasePath(), 'baseValues');
        const getMasterConfigDoc = () => doc(db, 'artifacts', appId, 'system', 'master');

        const showModal = (el) => { if (el) el.style.display = 'block'; };
        const hideModal = (el) => { if (el) el.style.display = 'none'; };
        const showMessage = (title, message) => {
            if(alertTitle) alertTitle.textContent = title;
            if(alertMessage) alertMessage.textContent = message;
            showModal(alertModal);
        };
        
        if(btnCloseAlert) btnCloseAlert.addEventListener('click', () => hideModal(alertModal));

        const closeButtons = [
            closeSupervisorModal, closeSectorModal, closeSectorIndicesModal, closeEmployeeModal, closeMasterReg
        ];
        closeButtons.forEach(btn => {
            if (btn) btn.addEventListener('click', () => { const modal = btn.closest('.modal'); if (modal) hideModal(modal); });
        });

        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) hideModal(event.target);
        };

        const switchView = (viewName) => {
            if (viewName === 'admin') {
                if(viewLaunch) viewLaunch.style.display = 'none';
                if(viewAdmin) viewAdmin.style.display = 'block';
                if(btnViewLaunch) btnViewLaunch.classList.replace('text-red-600', 'text-gray-600');
                if(btnViewAdmin) btnViewAdmin.classList.replace('text-gray-600', 'text-red-600');
                renderSupervisorsTable();
            } else { 
                if(viewLaunch) viewLaunch.style.display = 'grid';
                if(viewAdmin) viewAdmin.style.display = 'none';
                if(btnViewLaunch) btnViewLaunch.classList.replace('text-gray-600', 'text-red-600');
                if(btnViewAdmin) btnViewAdmin.classList.replace('text-red-600', 'text-gray-600');
            }
        };

        if(btnViewLaunch) btnViewLaunch.addEventListener('click', () => switchView('launch'));
        if(btnViewAdmin) btnViewAdmin.addEventListener('click', () => switchView('admin'));

        const setDefaultMonth = () => {
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            if(monthRefInput) monthRefInput.value = `${year}-${month}`;
        };

        const startFirebase = async () => {
            if (!firebaseConfig || !firebaseConfig.apiKey || firebaseConfig.apiKey.includes("COLE_SUA_API_KEY_AQUI")) {
                loginError.textContent = "Erro Crítico: Configuração do Firebase ausente.";
                loginError.classList.remove('hidden');
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await signInAnonymously(auth);

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if(currentUserIdDisplay) currentUserIdDisplay.textContent = currentUserId;
                        checkMasterRegistration();
                    } else {
                        currentUserId = null;
                    }
                });
            } catch (error) {
                loginError.textContent = `Erro de Conexão: ${error.message}`;
                loginError.classList.remove('hidden');
            }
        };
        
        const checkMasterRegistration = async () => {
             try {
                const docRef = getMasterConfigDoc();
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    if(masterRegisterContainer) masterRegisterContainer.classList.add('hidden');
                } else {
                    if(masterRegisterContainer) masterRegisterContainer.classList.remove('hidden');
                }
             } catch (error) {
                 console.error("Erro check master:", error);
             }
        };
        
        if(btnRegisterMaster) btnRegisterMaster.addEventListener('click', (e) => {
            e.preventDefault();
            if(masterRegistrationForm) masterRegistrationForm.reset();
            showModal(masterRegistrationModal);
        });
        
        if(cancelMasterReg) cancelMasterReg.addEventListener('click', () => hideModal(masterRegistrationModal));
        
        if(masterRegistrationForm) masterRegistrationForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = regMasterUsername.value.trim();
            const password = regMasterPassword.value;
            const confirm = regMasterConfirm.value;
            
            if (password !== confirm) return alert("Senhas não coincidem.");
            if (password.length < 6) return alert("Senha muito curta.");
            
            try {
                const passwordHash = await digestMessage(password);
                const docRef = getMasterConfigDoc();
                await setDoc(docRef, { username: username, passwordHash: passwordHash, createdAt: serverTimestamp() });
                alert("Master cadastrado! Faça login.");
                hideModal(masterRegistrationModal);
                checkMasterRegistration();
            } catch (error) {
                console.error(error);
                alert("Erro ao cadastrar.");
            }
        });

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginUsername.value.trim();
            const password = loginPassword.value;
            const passwordHash = await digestMessage(password);
            let loggedIn = false;

            try {
                const masterDocRef = getMasterConfigDoc();
                const masterDocSnap = await getDoc(masterDocRef);
                if (masterDocSnap.exists()) {
                    const masterData = masterDocSnap.data();
                    if (masterData.username === username && masterData.passwordHash === passwordHash) {
                        isMaster = true; isSupervisor = false; isRhUser = false;
                        currentSupervisorId = 'master'; loggedIn = true;
                    }
                } 
            } catch (error) { console.error(error); }
            
            if (!loggedIn) {
                try {
                    let q = query(getSupervisorsCollection(), where("username", "==", username), where("passwordHash", "==", passwordHash));
                    let querySnapshot = await getDocs(q);
                    
                    if (querySnapshot.empty) { 
                         q = query(getSupervisorsCollection(), where("username", "==", username), where("password", "==", password));
                         querySnapshot = await getDocs(q);
                         if (!querySnapshot.empty) alert("Atenção: Atualize sua senha para segurança.");
                    }
                    
                    if (!querySnapshot.empty) {
                        const supervisorDoc = querySnapshot.docs[0];
                        const supervisorData = supervisorDoc.data();
                        isMaster = false; isSupervisor = true;
                        currentSupervisorId = supervisorDoc.id;
                        currentSupervisorSectorId = supervisorData.sectorId;
                        
                        const sectorDoc = await getDoc(doc(getSectorsCollection(), currentSupervisorSectorId));
                        if (sectorDoc.exists() && sectorDoc.data().name.toUpperCase() === 'RH') {
                            isRhUser = true; isSupervisor = false;
                        } else { isRhUser = false; }
                        loggedIn = true;
                    }
                } catch (error) { console.error(error); }
            }

            if (loggedIn) {
                loginScreen.classList.add('hidden');
                appContent.classList.remove('hidden');
                switchView('launch'); 
                setDefaultMonth();
                loadAllData();
                applyPermissions();
            } else {
                loginError.textContent = "Usuário ou senha inválidos.";
                loginError.classList.remove('hidden');
            }
        });

        if(btnLogout) btnLogout.addEventListener('click', () => {
            isMaster = false; isSupervisor = false; isRhUser = false;
            currentSupervisorId = null; currentSupervisorSectorId = null;
            loginUsername.value = ''; loginPassword.value = '';
            loginError.classList.add('hidden');
            appContent.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            switchView('launch'); 
        });

        const applyPermissions = () => {
            if (adminControls) {
                if (isMaster || isSupervisor || isRhUser) adminControls.classList.remove('hidden');
                else adminControls.classList.add('hidden');
            }
            const masterEls = [btnOpenSupervisorModal, btnOpenSectorModal, btnViewAdmin];
            masterEls.forEach(el => { if (el) isMaster ? el.classList.remove('hidden') : el.classList.add('hidden'); });
            
            if (btnOpenEmployeeModal) isMaster || isSupervisor ? btnOpenEmployeeModal.classList.remove('hidden') : btnOpenEmployeeModal.classList.add('hidden');
            if (btnManageSectorIndices) isSupervisor ? btnManageSectorIndices.classList.remove('hidden') : btnManageSectorIndices.classList.add('hidden');

            if (isMaster || isRhUser) {
                if(supervisorLaunchFields) supervisorLaunchFields.classList.add('hidden');
                if(sectorFilterContainer) sectorFilterContainer.classList.remove('hidden');
                if (baseValueInput) baseValueInput.readOnly = !isMaster;
                if (btnSaveBaseValue) isMaster ? btnSaveBaseValue.classList.remove('hidden') : btnSaveBaseValue.classList.add('hidden');
            } else if (isSupervisor) {
                if(supervisorLaunchFields) supervisorLaunchFields.classList.remove('hidden');
                if(sectorFilterContainer) sectorFilterContainer.classList.add('hidden');
                if(baseValueInput) baseValueInput.readOnly = true;
                if(btnSaveBaseValue) btnSaveBaseValue.classList.add('hidden');
            }
            const actionCells = document.querySelectorAll('#history-action-header, [data-cell-type="action"]');
            actionCells.forEach(cell => { if (cell) (isMaster || isRhUser) ? cell.classList.add('hidden') : cell.classList.remove('hidden'); });
        };

        const loadAllData = () => {
            onSnapshot(query(getSectorsCollection()), (snapshot) => {
                globalSectors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateSectorSelects(globalSectors);
                loadEmployees();
                loadHistory();
                renderSectorsTable();
            }, () => applyPermissions());
            
            onSnapshot(query(getSupervisorsCollection()), (snapshot) => {
                globalSupervisors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (viewAdmin.style.display === 'block') renderSupervisorsTable();
            });
            loadBaseValue();
        };

        const populateSectorSelects = (sectors) => {
            [supervisorSector, employeeSector, sectorFilterSelect].forEach(select => {
                if (!select) return;
                const currentValue = select.value;
                select.innerHTML = select.id === 'sector-filter' ? '<option value="all">Todos os Setores</option>' : '<option value="">-- Selecione um setor --</option>';
                sectors.forEach(sector => {
                    const option = document.createElement('option');
                    option.value = sector.id;
                    option.textContent = sector.name;
                    select.appendChild(option);
                });
                select.value = currentValue;
            });
        };

        const loadEmployees = () => {
            let q = isSupervisor ? query(getEmployeesCollection(), where("sectorId", "==", currentSupervisorSectorId)) : query(getEmployeesCollection());
            onSnapshot(q, (snapshot) => {
                globalEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if(employeeSelect) {
                    employeeSelect.innerHTML = '<option value="">-- Selecione um colaborador --</option>';
                    globalEmployees.forEach(emp => {
                        const option = document.createElement('option');
                        option.value = emp.id;
                        option.textContent = emp.name;
                        employeeSelect.appendChild(option);
                    });
                }
                renderEmployeesTable();
            });
        };

        const loadBaseValue = async () => {
            const month = monthRefInput.value;
            if (!month) { if(baseValueInput) baseValueInput.value = ''; return; }
            if(baseValueLoading) baseValueLoading.classList.remove('hidden');
            try {
                const docSnap = await getDoc(doc(getBaseValuesCollection(), month));
                if (docSnap.exists()) baseValueInput.value = docSnap.data().value;
                else baseValueInput.value = '';
            } catch (e) { baseValueInput.value = ''; }
            finally { if(baseValueLoading) baseValueLoading.classList.add('hidden'); baseValueInput.classList.remove('hidden'); }
        };
        
        if(btnSaveBaseValue) btnSaveBaseValue.addEventListener('click', async () => {
            const month = monthRefInput.value;
            const value = parseFloat(baseValueInput.value);
            if (!month || isNaN(value)) return showMessage("Erro", "Dados inválidos.");
            try {
                await setDoc(doc(getBaseValuesCollection(), month), { value: value });
                showMessage("Sucesso", "Valor base salvo.");
            } catch (e) { showMessage("Erro", "Erro ao salvar."); }
        });

        const loadHistory = () => {
            const month = monthRefInput.value;
            const sectorFilter = sectorFilterSelect.value;
            if (!month) {
                 if(historyLoading) historyLoading.classList.remove('hidden');
                 return;
            }
            let q;
            if (isSupervisor) {
                q = query(getLaunchesCollection(), where("monthRef", "==", month), where("sectorId", "==", currentSupervisorSectorId));
            } else {
                q = sectorFilter === 'all' ? query(getLaunchesCollection(), where("monthRef", "==", month)) : query(getLaunchesCollection(), where("monthRef", "==", month), where("sectorId", "==", sectorFilter));
            }
            onSnapshot(q, (snapshot) => {
                globalHistory = [];
                snapshot.docs.forEach(doc => {
                    const data = doc.data();
                    const sector = globalSectors.find(s => s.id === data.sectorId);
                    globalHistory.push({ id: doc.id, ...data, sectorName: sector ? sector.name : 'Desconhecido', createdAt: data.createdAt?.toDate ? data.createdAt.toDate() : new Date(0) });
                });
                renderHistoryTable();
            }, () => { globalHistory = []; renderHistoryTable(); });
        };
        
        const renderHistoryTable = () => {
            if(historyTableBody) historyTableBody.innerHTML = ''; 
            if (globalHistory.length === 0) {
                if(historyTableBody) historyTableBody.innerHTML = '<tr><td colspan="8" class="text-center py-6 text-gray-500">Nenhum lançamento.</td></tr>';
                if(historyLoading) historyLoading.classList.add('hidden');
                return;
            }
            if(historyLoading) historyLoading.classList.add('hidden');
            const sorted = [...globalHistory].sort((a, b) => {
                const col = currentHistorySort.column;
                const dir = currentHistorySort.direction === 'asc' ? 1 : -1;
                let valA = a[col] || '', valB = b[col] || '';
                if (col === 'totalValue' || col === 'baseValue' || col === 'createdAt') return (valA - valB) * dir;
                return valA.toString().localeCompare(valB.toString()) * dir;
            });
            sorted.forEach(launch => {
                const tr = document.createElement('tr');
                const baseVal = `R$ ${launch.baseValue.toFixed(2).replace('.', ',')}`;
                const totalVal = `R$ ${launch.totalValue.toFixed(2).replace('.', ',')}`;
                const date = launch.createdAt instanceof Date ? launch.createdAt.toLocaleString('pt-BR') : '-';
                let actionHtml = launch.status === 'MÉDIA' ? '---' : `<button class="text-blue-600 mr-3" data-edit-id="${launch.id}">Editar</button><button class="text-red-600" data-delete-id="${launch.id}">Excluir</button>`;
                let statusClass = launch.status === 'FÉRIAS' ? 'text-blue-600' : (launch.status === 'MÉDIA' ? 'text-green-600' : 'text-red-600');
                let detailsHtml = (launch.status === 'FÉRIAS' || launch.status === 'MÉDIA') ? `<span class="${statusClass}">${launch.status}</span>` : `<button class="text-red-600" data-launch-id="${launch.id}">Ver +</button>`;
                
                tr.innerHTML = `<td class="px-4 py-3">${launch.monthRef}</td><td class="px-4 py-3">${launch.employeeName}</td><td class="px-4 py-3">${launch.sectorName}</td><td class="px-4 py-3">${baseVal}</td><td class="px-4 py-3 font-bold ${statusClass}">${totalVal}</td><td class="px-4 py-3 text-sm">${date}</td><td class="px-4 py-3">${detailsHtml}</td><td class="px-4 py-3" data-cell-type="action">${actionHtml}</td>`;
                const trDetails = document.createElement('tr');
                trDetails.id = `details-${launch.id}`;
                trDetails.classList.add('hidden', 'bg-gray-50');
                trDetails.innerHTML = `<td colspan="8" class="px-8 py-4"><ul class="list-disc list-inside">${launch.scores ? launch.scores.map(s => `<li>${s.name}: ${s.score}/${s.max}</li>`).join('') : ''}</ul></td>`;
                historyTableBody.appendChild(tr);
                historyTableBody.appendChild(trDetails);
            });
            applyPermissions();
        };

        if(employeeSelect) employeeSelect.addEventListener('change', (e) => {
            const empId = e.target.value;
            if (!empId) return renderIndices([]);
            const emp = globalEmployees.find(e => e.id === empId);
            if (!emp) return;
            vacationEmployee = emp;
            if(vacationMessage) vacationMessage.textContent = `${emp.name} está de férias?`;
            showModal(vacationModal);
        });
        
        if(btnVacationNo) btnVacationNo.addEventListener('click', () => {
            if (!vacationEmployee) return;
            const sec = globalSectors.find(s => s.id === vacationEmployee.sectorId);
            renderIndices(sec ? sec.indices : []);
            vacationEmployee = null;
            hideModal(vacationModal);
        });

        if(btnVacationYes) btnVacationYes.addEventListener('click', async () => {
            if (!vacationEmployee) return;
            const month = monthRefInput.value;
            if (!month) return showMessage("Erro", "Selecione o mês.");
            
            const existing = globalHistory.find(l => l.employeeId === vacationEmployee.id);
            if (existing) { hideModal(vacationModal); return showMessage("Bloqueio", "Já existe lançamento para este colaborador."); }

            try {
                await addDoc(getLaunchesCollection(), {
                    monthRef: month, employeeId: vacationEmployee.id, employeeName: vacationEmployee.name, sectorId: vacationEmployee.sectorId,
                    launchedBy: currentUserId, launchedBySupervisor: currentSupervisorId, baseValue: parseFloat(baseValueInput.value) || 0, totalValue: 0, scores: [], status: "FÉRIAS", createdAt: serverTimestamp()
                });
                showMessage("Sucesso", "Férias lançadas.");
                if(employeeSelect) employeeSelect.value = "";
                renderIndices([]);
            } catch (e) { console.error(e); showMessage("Erro", "Falha ao lançar."); }
            finally { vacationEmployee = null; hideModal(vacationModal); }
        });

        const renderIndices = (indices) => {
            if(indicesContainer) indicesContainer.innerHTML = '';
            if (!indices || indices.length === 0) {
                indicesContainer.classList.remove('grid-layout');
                indicesContainer.innerHTML = '<p class="text-sm text-gray-500">Sem índices.</p>';
                return calculateTotal();
            }
            indicesContainer.classList.add('grid-layout');
            indices.forEach(idx => {
                const div = document.createElement('div');
                div.className = 'index-item';
                div.innerHTML = `<label>${idx.name} (Max: ${idx.perc}%)</label><input type="number" class="score-input w-full px-3 py-2 border rounded" data-max="${idx.perc}" data-name="${idx.name}" min="0" max="${idx.perc}">`;
                
                // Validation logic
                const input = div.querySelector('input');
                input.addEventListener('input', (e) => {
                    const max = parseFloat(e.target.dataset.max);
                    let val = parseFloat(e.target.value);
                    
                    if (val > max) {
                        e.target.value = max;
                    }
                    if (val < 0) {
                        e.target.value = 0;
                    }
                    calculateTotal();
                });
                
                indicesContainer.appendChild(div);
            });
            calculateTotal();
        };

        const calculateTotal = () => {
            const base = parseFloat(baseValueInput.value) || 0;
            let points = 0;
            document.querySelectorAll('.score-input').forEach(inp => points += parseFloat(inp.value) || 0);
            if(totalCalculated) totalCalculated.textContent = `R$ ${(base * (points / 100)).toFixed(2)}`;
        };

        if(launchForm) launchForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const empId = employeeSelect.value;
            const month = monthRefInput.value;
            if (!empId || !month) return showMessage("Erro", "Preencha tudo.");
            
            if (!currentEditingLaunchId) {
                const existing = globalHistory.find(l => l.employeeId === empId);
                if (existing) return showMessage("Bloqueio", "Já existe lançamento.");
            }

            const scores = [];
            let points = 0;
            document.querySelectorAll('.score-input').forEach(inp => {
                const v = parseFloat(inp.value) || 0;
                scores.push({ name: inp.dataset.name, score: v, max: parseFloat(inp.dataset.max) });
                points += v;
            });

            const base = parseFloat(baseValueInput.value) || 0;
            const data = {
                monthRef: month, employeeId: empId, employeeName: globalEmployees.find(e=>e.id===empId).name, sectorId: globalEmployees.find(e=>e.id===empId).sectorId,
                launchedBy: currentUserId, launchedBySupervisor: currentSupervisorId, baseValue: base, totalValue: base * (points / 100), scores: scores, status: "", createdAt: serverTimestamp()
            };

            try {
                if (currentEditingLaunchId) {
                    delete data.createdAt;
                    await updateDoc(doc(getLaunchesCollection(), currentEditingLaunchId), data);
                    showMessage("Sucesso", "Atualizado.");
                } else {
                    await addDoc(getLaunchesCollection(), data);
                    showMessage("Sucesso", "Lançado.");
                }
                if(isSupervisor) updateSupervisorAverage(month, currentSupervisorId, globalSupervisors.find(s=>s.id===currentSupervisorId).name, currentSupervisorSectorId);
                resetLaunchFormToCreateMode();
            } catch (e) { console.error(e); showMessage("Erro", "Falha ao salvar."); }
        });

        const resetLaunchFormToCreateMode = () => {
            currentEditingLaunchId = null;
            if(btnSubmitLaunch) btnSubmitLaunch.textContent = "Lançar Remuneração";
            if(btnCancelEdit) btnCancelEdit.classList.add('hidden');
            if(employeeSelect) employeeSelect.value = "";
            renderIndices([]);
            if(totalCalculated) totalCalculated.textContent = "R$ 0,00";
        };
        if(btnCancelEdit) btnCancelEdit.addEventListener('click', resetLaunchFormToCreateMode);

        const loadLaunchForEdit = async (id) => {
            try {
                const snap = await getDoc(doc(getLaunchesCollection(), id));
                if (!snap.exists()) return showMessage("Erro", "Não encontrado.");
                const data = snap.data();
                monthRefInput.value = data.monthRef;
                await loadBaseValue();
                employeeSelect.value = data.employeeId;
                const emp = globalEmployees.find(e => e.id === data.employeeId);
                const sec = globalSectors.find(s => s.id === emp.sectorId);
                renderIndices(sec ? sec.indices : []);
                setTimeout(() => {
                    data.scores.forEach(s => {
                        const inp = document.querySelector(`.score-input[data-name="${s.name}"]`);
                        if (inp) inp.value = s.score;
                    });
                    calculateTotal();
                }, 100);
                currentEditingLaunchId = id;
                btnSubmitLaunch.textContent = "Salvar Alterações";
                btnCancelEdit.classList.remove('hidden');
                window.scrollTo({ top: 0, behavior: 'smooth' });
            } catch (e) { console.error(e); }
        };

        document.body.addEventListener('click', async (e) => {
            const t = e.target.closest('button');
            if (!t) return;
            if (t.dataset.launchId) document.getElementById(`details-${t.dataset.launchId}`).classList.toggle('hidden');
            if (t.dataset.editId && !t.dataset.editType) loadLaunchForEdit(t.dataset.editId);
            if (t.dataset.deleteId) {
                itemToDelete = { id: t.dataset.deleteId, type: t.dataset.deleteType || 'lançamento', collection: t.dataset.deleteType ? (t.dataset.deleteType === 'supervisor' ? getSupervisorsCollection() : (t.dataset.deleteType === 'sector' ? getSectorsCollection() : getEmployeesCollection())) : getLaunchesCollection() };
                showModal(deleteConfirmModal);
            }
            if (t.id === 'btn-open-supervisor-modal') { if(supervisorForm) supervisorForm.reset(); showModal(supervisorModal); }
            if (t.id === 'btn-open-sector-modal') { if(sectorForm) sectorForm.reset(); showModal(sectorModal); }
            if (t.id === 'btn-open-employee-modal') { 
                if(employeeForm) employeeForm.reset(); 
                if(isSupervisor) { employeeSector.value = currentSupervisorSectorId; employeeSector.disabled = true; } else employeeSector.disabled = false;
                showModal(employeeModal); 
            }
            if (t.id === 'btn-manage-sector-indices') {
                if(!currentSupervisorSectorId) return;
                const s = globalSectors.find(sec=>sec.id===currentSupervisorSectorId);
                if(s) {
                    editIndicesSectorId.value = s.id; sectorIndicesName.value = s.name;
                    indicesList.innerHTML = '';
                    (s.indices||[]).forEach(i => createIndexField(i.name, i.perc));
                    if(!(s.indices||[]).length) createIndexField();
                    updateIndicesTotal();
                    showModal(sectorIndicesModal);
                }
            }
        });
        
        if(addIndexField) addIndexField.addEventListener('click', () => createIndexField());
        const createIndexField = (n='', p='') => {
            const d = document.createElement('div'); d.className = 'flex items-center gap-2';
            d.innerHTML = `<div class="flex-1"><label class="text-xs">Nome</label><input class="index-name w-full px-3 py-2 border rounded" value="${n}" required></div><div class="w-24"><label class="text-xs">%</label><input type="number" class="index-perc w-full px-3 py-2 border rounded" value="${p}" required></div><button type="button" class="rm-idx text-red-500">X</button>`;
            d.querySelector('.rm-idx').onclick = () => { d.remove(); updateIndicesTotal(); };
            d.querySelector('.index-perc').oninput = updateIndicesTotal;
            indicesList.appendChild(d);
        };
        const updateIndicesTotal = () => {
            let t = 0; document.querySelectorAll('.index-perc').forEach(i => t += parseFloat(i.value)||0);
            indicesTotalPercentage.textContent = `Total: ${t}%`;
            btnSubmitIndicesForm.disabled = t !== 100;
            if(t!==100) indicesTotalPercentage.classList.add('text-red-600'); else indicesTotalPercentage.classList.remove('text-red-600');
        };

        if(sectorIndicesForm) sectorIndicesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const idx = []; let t = 0;
            document.querySelectorAll('#indices-list .flex').forEach(r => {
                const n = r.querySelector('.index-name').value.trim(); const p = parseFloat(r.querySelector('.index-perc').value);
                if(n && p>0) { idx.push({name:n, perc:p}); t+=p; }
            });
            if(t!==100) return alert("Total deve ser 100%");
            await updateDoc(doc(getSectorsCollection(), editIndicesSectorId.value), {indices: idx});
            alert("Salvo."); hideModal(sectorIndicesModal);
        });

        // Listeners Modais Cancel
        [cancelSupervisorModal, cancelSectorModal, cancelEmployeeModal, cancelSectorIndicesModal, btnCancelDelete].forEach(b => b ? b.onclick = () => document.querySelectorAll('.modal').forEach(m=>m.style.display='none') : null);

        // Listeners Salvar Entidades
        if(supervisorForm) supervisorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const p = supervisorPassword.value;
            const data = { name: supervisorName.value, sectorId: supervisorSector.value, username: supervisorUsername.value.toLowerCase() };
            if(p) data.passwordHash = await digestMessage(p);
            else if(!editSupervisorId.value) return alert("Senha obrigatória");
            
            // Check for duplicate sector supervisor
            const sectorTaken = globalSupervisors.find(s => s.sectorId === supervisorSector.value && s.id !== editSupervisorId.value);
            if (sectorTaken) return showMessage("Erro", "Setor já tem supervisor.");

            const col = getSupervisorsCollection();
            if(editSupervisorId.value) await updateDoc(doc(col, editSupervisorId.value), data);
            else await addDoc(col, data);
            alert("Salvo."); hideModal(supervisorModal);
        });

        if(sectorForm) sectorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = { name: sectorName.value.trim() };
            const col = getSectorsCollection();
            if(editSectorId.value) await updateDoc(doc(col, editSectorId.value), data);
            else { data.indices = []; await addDoc(col, data); }
            alert("Salvo."); hideModal(sectorModal);
        });

        if(employeeForm) employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const data = { name: employeeName.value.trim(), sectorId: employeeSector.value };
            const col = getEmployeesCollection();
            if(editEmployeeId.value) await updateDoc(doc(col, editEmployeeId.value), data);
            else await addDoc(col, data);
            alert("Salvo."); hideModal(employeeModal);
        });

        let itemToDelete = {};
        if(btnConfirmDelete) btnConfirmDelete.addEventListener('click', async () => {
            if(!itemToDelete.id) return;
            try { await deleteDoc(doc(itemToDelete.collection, itemToDelete.id)); alert("Excluído."); }
            catch(e){ console.error(e); alert("Erro ao excluir."); }
            hideModal(deleteConfirmModal);
        });

        const renderSupervisorsTable = () => {
            supervisorsTableBody.innerHTML = globalSupervisors.map(s => {
                const sec = globalSectors.find(x=>x.id===s.sectorId);
                return `<tr><td class="px-4 py-2">${s.name}</td><td class="px-4 py-2">${s.username}</td><td class="px-4 py-2">${sec?sec.name:'-'}</td><td class="px-4 py-2"><button class="text-blue-600 mr-2" onclick="openSupEdit('${s.id}')">Editar</button><button class="text-red-600" data-delete-id="${s.id}" data-delete-type="supervisor">Excluir</button></td></tr>`;
            }).join('');
            // Re-attach listeners for dynamic edit buttons in admin panel is complex with innerHTML, using global click listener instead
        };
        // Helpers for render
        const renderSectorsTable = () => {
            sectorsTableBody.innerHTML = globalSectors.map(s => `<tr><td class="px-4 py-2">${s.name}</td><td class="px-4 py-2">${(s.indices||[]).length} índices</td><td class="px-4 py-2"><button class="text-red-600" data-delete-id="${s.id}" data-delete-type="sector">Excluir</button></td></tr>`).join('');
        };
        const renderEmployeesTable = () => {
            employeesTableBody.innerHTML = globalEmployees.map(e => {
                const sec = globalSectors.find(x=>x.id===e.sectorId);
                return `<tr><td class="px-4 py-2">${e.name}</td><td class="px-4 py-2">${sec?sec.name:'-'}</td><td class="px-4 py-2"><button class="text-blue-600 mr-2" onclick="openEmpEdit('${e.id}')">Editar</button><button class="text-red-600" data-delete-id="${e.id}" data-delete-type="employee">Excluir</button></td></tr>`;
            }).join('');
        };
        
        // Global Edit Handlers for Admin Panel (simplification)
        window.openSupEdit = (id) => {
            const s = globalSupervisors.find(x=>x.id===id);
            if(s) {
                editSupervisorId.value = s.id; supervisorName.value = s.name; supervisorSector.value = s.sectorId; supervisorUsername.value = s.username;
                supervisorPassword.required = false; supervisorPassword.placeholder = "Deixe em branco para manter";
                showModal(supervisorModal);
            }
        };
        window.openEmpEdit = (id) => {
            const e = globalEmployees.find(x=>x.id===id);
            if(e) {
                editEmployeeId.value = e.id; employeeName.value = e.name; employeeSector.value = e.sectorId;
                employeeSector.disabled = false;
                showModal(employeeModal);
            }
        };

        const updateSupervisorAverage = async (month, supervisorId, supervisorName, sectorId) => {
            if (!month || !supervisorId || !supervisorName) return;
            try {
                const q = query(getLaunchesCollection(),
                    where("monthRef", "==", month),
                    where("launchedBySupervisor", "==", supervisorId),
                    where("status", "==", "")
                );
                const querySnapshot = await getDocs(q);
                let totalSum = 0;
                let launchCount = 0;
                
                querySnapshot.docs.forEach(doc => {
                    const data = doc.data();
                    if (data.type !== 'average') {
                        totalSum += data.totalValue;
                        launchCount++;
                    }
                });

                if (launchCount === 0) {
                    const avgLaunchId = `avg_${supervisorId}_${month.replace('-', '')}`;
                    await deleteDoc(doc(getLaunchesCollection(), avgLaunchId));
                    return;
                }

                const averageValue = totalSum / launchCount;
                const avgLaunchId = `avg_${supervisorId}_${month.replace('-', '')}`;
                
                const avgLaunchData = {
                    monthRef: month,
                    employeeId: `avg_${supervisorId}`, 
                    employeeName: `${supervisorName} (Média Equipe)`,
                    sectorId: sectorId,
                    launchedBy: 'system',
                    launchedBySupervisor: supervisorId,
                    baseValue: 0,
                    totalValue: averageValue,
                    scores: [],
                    status: "MÉDIA",
                    type: "average",
                    createdAt: serverTimestamp()
                };
                await setDoc(doc(getLaunchesCollection(), avgLaunchId), avgLaunchData, { merge: true }); 
            } catch (error) { console.error("Erro media:", error); }
        };

        startFirebase();
    </script>
</body>
</html>
