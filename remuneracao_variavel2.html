<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ferramenta de Remuneração Variável</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Tema ETECC (Vermelho, Preto, Branco) */
            --primary-red: #d90000; /* Vermelho ETECC principal */
            --primary-red-dark: #b30000; /* Vermelho mais escuro para hover */
            
            --primary-black: #222222; /* Preto/Cinza escuro ETECC */
            --primary-black-dark: #000000; /* Preto mais escuro para hover */

            --primary-blue: #0f62fe; /* Azul (para "Cadastrar Colaborador") */
            --primary-blue-dark: #0353e9; 
            
            --primary-green: #198754; /* Verde (para "Salvar Valor Base" e Setor) */
            --primary-green-dark: #157347;

            --primary-orange: #f97316; /* Laranja (para "Gerenciar Metas") */
            --primary-orange-dark: #ea580c;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        /* Estilos para o Modal */
        .modal {
            display: none; /* Oculto por padrão */
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.5); /* Fundo escuro semi-transparente */
            padding-top: 60px; /* Espaço para o modal não ficar colado no topo */
        }
        .modal-content {
            background-color: #ffffff;
            margin: 5% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 500px;
            border-radius: 12px;
            animation: slideDown 0.3s ease-out;
        }
        @keyframes slideDown {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }
        .close:hover,
        .close:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }
        
        /* Estilo Login */
        #login-screen {
            background-color: var(--primary-black); /* Fundo preto */
        }
        
        /* Estilos Tabela de Histórico */
        #historyTable th, #historyTable td {
            border: 1px solid #e2e8f0; /* Borda cinza clara */
            padding: 8px 12px;
            white-space: nowrap; /* Impede quebra de linha */
        }
        #historyTable th {
            background-color: #f8fafc; /* Fundo levemente cinza no cabeçalho */
            cursor: pointer; /* Indica que é clicável para ordenar */
            user-select: none; /* Impede seleção de texto */
            position: sticky; /* Faz o cabeçalho grudar no topo */
            top: 0;
        }
        #historyTable th:hover {
            background-color: #f1f5f9;
        }
        #historyTable .sort-arrow {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.3;
        }
        #historyTable .sort-arrow.active {
            opacity: 1;
        }
        .history-details-row td {
            background-color: #f9fafb; /* Fundo levemente diferente para detalhes */
            padding: 12px 16px;
            border-bottom: 1px solid #e2e8f0;
        }

        /* Abas do Painel de Gestão */
        .tab-button {
            padding: 8px 16px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            color: #6b7280; /* Cinza */
        }
        .tab-button.active {
            border-bottom: 2px solid var(--primary-red);
            color: var(--primary-red);
            font-weight: 600;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        /* Layout dos campos de pontuação */
        #indices-container.grid-layout {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }
        #indices-container .indice-item {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }
        #indices-container .indice-item label {
            font-size: 0.875rem; /* 14px */
            color: #374151; /* gray-700 */
        }
        #indices-container .indice-item input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #D1D5DB; /* gray-300 */
            border-radius: 6px;
        }

    </style>
    <!-- Fonte Inter -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body class="bg-gray-100">

    <!-- Tela de Login -->
    <div id="login-screen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
        <div class="bg-white w-full max-w-sm p-8 rounded-lg shadow-xl border border-gray-200">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Login - Remuneração Variável</h2>
            
            <form id="login-form">
                <div class="mb-4">
                    <label for="login-username" class="block text-sm font-medium text-gray-700 mb-1">Usuário</label>
                    <input type="text" id="login-username" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                <div class="mb-6">
                    <label for="login-password" class="block text-sm font-medium text-gray-700 mb-1">Senha</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                
                <button type="submit" class="w-full bg-red-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150">
                    Entrar
                </button>

                <p id="login-error" class="text-red-500 text-sm text-center mt-4 hidden">Usuário ou senha inválidos.</p>
                <!-- Dica de senha foi REMOVIDA -->
            </form>
        </div>
    </div>
    
    <!-- Conteúdo Principal da Aplicação (Oculto até o login) -->
    <div id="app-content" class="hidden">
        
        <!-- Cabeçalho -->
        <header class="bg-white shadow-md border-b border-gray-200">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                <div class="flex items-center gap-3">
                    <svg class="h-8 w-8 text-red-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <h1 class="text-xl font-bold text-gray-800">Ferramenta de Remuneração Variável</h1>
                </div>
                <div class="flex items-center gap-4">
                    <button id="btn-view-launch" class="text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0c-1.657 0-3-.895-3-2s1.343-2 3-2 3-.895 3-2-1.343-2-3-2m0 8c-1.11 0-2.08-.402-2.599-1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M12 15c-1.11 0-2.08-.402-2.599-1M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4M4 7v1.522c0 .414.336.75.75.75h14.5a.75.75 0 00.75-.75V7" /></svg>
                        <span>Lançamento</span>
                    </button>
                    <button id="btn-view-admin" class="hidden text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                        <span>Painel de Gestão</span>
                    </button>
                    <button id="btn-logout" class="text-gray-600 hover:text-red-600 flex items-center gap-1.5 px-3 py-1.5 rounded-md hover:bg-red-50">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" />
                        </svg>
                        <span>Sair</span>
                    </button>
                </div>
            </div>
        </header>

        <!-- Container Principal -->
        <div class="container mx-auto p-4 max-w-7xl">

            <!-- Painel de Cadastro (Master) -->
            <div id="admin-controls" class="hidden bg-white p-4 rounded-lg shadow border border-gray-200 mb-6">
                <!-- Contêiner dos botões -->
                <div class="flex flex-wrap items-center justify-end gap-3">
                    <p class="text-sm font-medium text-gray-600 hidden" id="user-id-log">
                        Seu ID de Usuário (para log): <span class="font-mono bg-gray-200 text-gray-800 px-2 py-0.5 rounded-md" id="current-user-id-display">Carregando...</span>
                    </p>
                    
                    <!-- Botões do Admin Master -->
                    <button id="btn-open-supervisor-modal" class="hidden flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>
                        <span>+ Cadastrar Gestão</span>
                    </button>
                    <button id="btn-open-sector-modal" class="hidden flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-150">
                         <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a2 2 0 01-2 2H6a2 2 0 01-2-2V4z" /></svg>
                        <span>+ Cadastrar Setor</span>
                    </button>
                    <button id="btn-open-employee-modal" class="hidden flex items-center gap-2 bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M18 9v3m0 0v3m0-3h3m-3 0h-3m-2-5a4 4 0 11-8 0 4 4 0 018 0zM3 20a6 6 0 0112 0v1H3v-1z" /></svg>
                        <span>+ Cadastrar Colaborador</span>
                    </button>
                    
                    <!-- Botão do Supervisor (Gerenciar Metas) -->
                    <button id="btn-manage-sector-indices" class="hidden flex items-center gap-2 bg-orange-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-600 transition duration-150">
                        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.072-.267-2.09-.75-3.042z" /></svg>
                        <span>Gerenciar Metas</span>
                    </button>
                </div>
            </div>

            <!-- Visão: Lançamento -->
            <div id="view-launch" class="grid grid-cols-1 md:grid-cols-3 gap-6">

                <!-- Coluna da Esquerda: Novo Lançamento -->
                <div class="md:col-span-1 bg-white p-6 rounded-lg shadow border border-gray-200 h-fit">
                    <h2 class="text-xl font-bold text-gray-800 mb-6">Novo Lançamento</h2>
                    
                    <form id="launch-form">
                        <div class="space-y-5">
                            <div>
                                <label for="month-ref" class="block text-sm font-medium text-gray-700">Mês de Referência (Filtro)</label>
                                <input type="month" id="month-ref" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500">
                            </div>

                            <!-- Filtro de Setor (Master/RH) -->
                            <div id="sector-filter-container" class="hidden">
                                <label for="sector-filter" class="block text-sm font-medium text-gray-700">Filtrar por Setor</label>
                                <select id="sector-filter" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white">
                                    <option value="all">Todos os Setores</option>
                                    <!-- Options carregadas via JS -->
                                </select>
                            </div>

                            <div>
                                <label for="base-value" class="block text-sm font-medium text-gray-700">Valor Base Variável (R$)</label>
                                <div class="mt-1 flex gap-2">
                                    <input type="number" id="base-value" placeholder="Ex: 1000.00" class="flex-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" readonly>
                                    <button type="button" id="btn-save-base-value" class="hidden bg-green-600 text-white px-5 py-2 rounded-md font-semibold hover:bg-green-700 transition duration-150">
                                        Salvar
                                    </button>
                                </div>
                                 <p id="base-value-loading" class="text-sm text-gray-500 mt-1 hidden">Carregando valor...</p>
                            </div>
                            
                            <!-- Campos do Supervisor (Ocultos para Master/RH) -->
                            <div id="supervisor-launch-fields" class="hidden space-y-5">
                                <hr>
                                <div>
                                    <label for="employee-select" class="block text-sm font-medium text-gray-700">Colaborador</label>
                                    <select id="employee-select" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white">
                                        <option value="">-- Selecione um colaborador --</option>
                                        <!-- Options carregadas via JS -->
                                    </select>
                                </div>

                                <div>
                                    <label class="block text-sm font-medium text-gray-700">Insira as pontuações</label>
                                    <div id="indices-container" class="mt-2 p-4 bg-gray-50 border border-gray-200 rounded-md min-h-[100px] flex items-center justify-center">
                                        <p class="text-sm text-gray-500">Selecione um colaborador para ver os índices de pontuação.</p>
                                    </div>
                                </div>

                                <div class="bg-blue-50 border border-blue-200 p-4 rounded-lg text-center">
                                    <p class="text-sm font-medium text-blue-700">Total Variável Calculado:</p>
                                    <p id="total-calculated" class="text-3xl font-bold text-red-600 mt-1">R$ 0,00</p>
                                </div>

                                <button type="submit" id="btn-submit-launch" class="w-full bg-red-600 text-white py-3 px-4 rounded-md font-semibold hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 transition duration-150 text-lg">
                                    Lançar Remuneração
                                </button>
                                <button type="button" id="btn-cancel-edit" class="hidden w-full bg-gray-600 text-white py-2 px-4 rounded-md font-semibold hover:bg-gray-700 transition duration-150">
                                    Cancelar Edição
                                </button>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Coluna da Direita: Histórico -->
                <div class="md:col-span-2 bg-white p-6 rounded-lg shadow border border-gray-200">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-xl font-bold text-gray-800">Histórico de Lançamentos</h2>
                        <button id="btn-download-csv" class="flex items-center gap-2 bg-white text-gray-700 px-3 py-1.5 rounded-md border border-gray-300 hover:bg-gray-50 transition duration-150 text-sm">
                            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                            <span>Download CSV</span>
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto">
                        <table id="historyTable" class="min-w-full divide-y divide-gray-200 border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th data-sort="monthRef" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Mês Ref. <span class="sort-arrow"></span></th>
                                    <th data-sort="employeeName" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Colaborador <span class="sort-arrow"></span></th>
                                    <th data-sort="sectorName" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor <span class="sort-arrow"></span></th>
                                    <th data-sort="baseValue" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Base (R$) <span class="sort-arrow"></span></th>
                                    <th data-sort="totalValue" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total (R$) <span class="sort-arrow"></span></th>
                                    <th data-sort="createdAt" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lançado Em <span class="sort-arrow"></span></th>
                                    <th data-sort="details" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Detalhes <span class="sort-arrow"></span></th>
                                    <th id="history-action-header" data-sort="action" class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ação <span class="sort-arrow"></span></th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body" class="bg-white divide-y divide-gray-200">
                                <tr id="history-loading">
                                    <td colspan="8" class="text-center py-6 text-gray-500">
                                        Carregando histórico...
                                    </td>
                                </tr>
                                <!-- Linhas de dados serão inseridas aqui -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Visão: Painel de Gestão (Master) -->
            <div id="view-admin" class="hidden">
                <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
                    <h2 class="text-xl font-bold text-gray-800 mb-4">Painel de Gestão (Admin Master)</h2>

                    <!-- Abas -->
                    <div class="border-b border-gray-200 mb-6">
                        <nav class="flex -mb-px" aria-label="Tabs">
                            <button class="tab-button active" data-tab="supervisors">Supervisores</button>
                            <button class="tab-button" data-tab="sectors">Setores</button>
                            <button class="tab-button" data-tab="employees">Colaboradores</button>
                        </nav>
                    </div>

                    <!-- Conteúdo das Abas -->
                    <div>
                        <!-- Aba Supervisores -->
                        <div id="tab-supervisors" class="tab-content active">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Usuário (Login)</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="supervisors-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Linhas de dados serão inseridas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Aba Setores -->
                        <div id="tab-sectors" class="tab-content">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome do Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Índices Definidos</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="sectors-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Linhas de dados serão inseridas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <!-- Aba Colaboradores -->
                        <div id="tab-employees" class="tab-content">
                            <div class="overflow-x-auto">
                                <table class="min-w-full divide-y divide-gray-200 border">
                                    <thead class="bg-gray-50">
                                        <tr>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nome</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Setor</th>
                                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody id="employees-table-body" class="bg-white divide-y divide-gray-200">
                                        <!-- Linhas de dados serão inseridas aqui -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div> <!-- Fim container -->
    </div> <!-- Fim app-content -->

    <!-- Modal: Cadastrar/Editar Supervisor (Gestão) -->
    <div id="supervisor-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-supervisor-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="supervisor-modal-title">Cadastrar Novo Supervisor</h2>
            <form id="supervisor-form">
                <input type="hidden" id="edit-supervisor-id">
                <div class="space-y-4">
                    <div>
                        <label for="supervisor-name" class="block text-sm font-medium text-gray-700">Nome do Supervisor</label>
                        <input type="text" id="supervisor-name" placeholder="Ex: Maria Gestora" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="supervisor-sector" class="block text-sm font-medium text-gray-700">Setor do Supervisor</label>
                        <div class="flex gap-2">
                            <select id="supervisor-sector" class="flex-1 mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white" required>
                                <option value="">-- Selecione um setor --</option>
                                <!-- Opções carregadas via JS -->
                            </select>
                            <!-- O botão "+ Novo Setor" foi REMOVIDO daqui -->
                        </div>
                    </div>
                    <div>
                        <label for="supervisor-username" class="block text-sm font-medium text-gray-700">Usuário (para login)</label>
                        <input type="text" id="supervisor-username" placeholder="Ex: maria.gestora" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="supervisor-password" class="block text-sm font-medium text-gray-700">Senha (para login)</label>
                        <input type="password" id="supervisor-password" placeholder="Mínimo 6 caracteres" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                        <div class="flex items-center mt-2">
                             <input type="checkbox" id="show-password-supervisor" class="h-4 w-4 text-red-600 border-gray-300 rounded focus:ring-red-500">
                             <label for="show-password-supervisor" class="ml-2 block text-sm text-gray-900">Mostrar senha</label>
                        </div>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="btn-cancel bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium hover:bg-gray-300" data-modal="supervisor-modal">Cancelar</button>
                    <button type="submit" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Salvar Supervisor</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cadastrar/Editar Setor (Master) -->
    <div id="sector-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-sector-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="sector-modal-title">Cadastrar Novo Setor</h2>
            <form id="sector-form">
                <input type="hidden" id="edit-sector-id">
                <div>
                    <label for="sector-name" class="block text-sm font-medium text-gray-700">Nome do Setor</label>
                    <input type="text" id="sector-name" placeholder="Ex: Vendas" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                </div>
                
                <!-- A definição de índices foi REMOVIDA para o Master -->

                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="btn-cancel bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium hover:bg-gray-300" data-modal="sector-modal">Cancelar</button>
                    <button type="submit" id="btn-save-sector" class="bg-green-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-green-700">Salvar Setor</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- Modal: Gerenciar Metas (Supervisor) -->
    <div id="indices-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-indices-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6">Gerenciar Metas (Índices)</h2>
            <form id="indices-form">
                <input type="hidden" id="edit-indices-sector-id">
                <div class="space-y-4">
                    <div>
                        <label for="indices-sector-name" class="block text-sm font-medium text-gray-700">Setor</label>
                        <input type="text" id="indices-sector-name" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100" readonly>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700">Defina os Índices:</label>
                        <div id="indices-list" class="mt-2 space-y-3">
                            <!-- Índices dinâmicos serão inseridos aqui -->
                        </div>
                        <button type="button" id="btn-add-indice" class="mt-3 text-sm text-blue-600 hover:text-blue-800 font-medium">+ Adicionar Índice</button>
                    </div>
                    <div class="pt-2 text-right">
                        <span class="text-lg font-bold" id="indices-total-percent">Total: 0%</span>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="btn-cancel bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium hover:bg-gray-300" data-modal="indices-modal">Cancelar</button>
                    <button type="submit" id="btn-save-indices" class="bg-orange-500 text-white px-4 py-2 rounded-md font-semibold hover:bg-orange-600">Salvar Índices</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Cadastrar/Editar Colaborador -->
    <div id="employee-modal" class="modal">
        <div class="modal-content">
            <span class="close" id="close-employee-modal">&times;</span>
            <h2 class="text-xl font-bold mb-6" id="employee-modal-title">Cadastrar Novo Colaborador</h2>
            <form id="employee-form">
                <input type="hidden" id="edit-employee-id">
                <div class="space-y-4">
                    <div>
                        <label for="employee-name" class="block text-sm font-medium text-gray-700">Nome do Colaborador</label>
                        <input type="text" id="employee-name" placeholder="Ex: João da Silva" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500" required>
                    </div>
                    <div>
                        <label for="employee-sector" class="block text-sm font-medium text-gray-700">Setor do Colaborador</label>
                        <!-- O Supervisor (não-master) verá este campo desabilitado e preenchido com seu setor -->
                        <select id="employee-sector" class="mt-1 w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-red-500 focus:border-red-500 bg-white" required>
                            <option value="">-- Selecione um setor --</option>
                            <!-- Opções carregadas via JS -->
                        </select>
                    </div>
                </div>
                <div class="mt-6 flex justify-end gap-3">
                    <button type="button" class="btn-cancel bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium hover:bg-gray-300" data-modal="employee-modal">Cancelar</button>
                    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-blue-700">Salvar Colaborador</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Confirmação de Exclusão -->
    <div id="delete-confirm-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4">Confirmar Exclusão</h2>
            <p id="delete-confirm-message">Você tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="mt-6 flex justify-end gap-3">
                <button type="button" class="btn-cancel bg-gray-200 text-gray-700 px-4 py-2 rounded-md font-medium hover:bg-gray-300" data-modal="delete-confirm-modal">Cancelar</button>
                <button id="btn-delete-confirm" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal: Aviso (para erros de validação, etc) -->
    <div id="alert-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-4" id="alert-modal-title">Aviso</h2>
            <p id="alert-modal-message">Mensagem de aviso.</p>
            <div class="mt-6 flex justify-end">
                <button id="btn-alert-ok" class="bg-red-600 text-white px-4 py-2 rounded-md font-semibold hover:bg-red-700">OK</button>
            </div>
        </div>
    </div>


    <!-- Firebase SDK -->
    <script type="module">
        // Importações do Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, doc, getDoc, setDoc, addDoc, updateDoc, deleteDoc, 
            onSnapshot, collection, query, where, getDocs, writeBatch, serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

         // --- IDs Globais ---
        
        // ATENÇÃO: Cole seu 'firebaseConfig' (da Etapa 3 do guia) AQUI EMBAIXO:
        const firebaseConfig = {
            apiKey: "AIzaSyCUf800FNv--emagtwh5YevSPqFtk7Miiw",
            authDomain: "remuneracao-equipe.firebaseapp.com",
            projectId: "remuneracao-equipe",
            storageBucket: "remuneracao-equipe.firebasestorage.app",
            messagingSenderId: "1070188778724",
            appId: "1:1070188778724:web:684e19b2259a99b17288f1"
        };
 // Este é o "caminho" no banco de dados. NÃO use espaços.
        const appId = 'remuneracao';
        // --- Variáveis Globais de Estado ---
        let db, auth;
        let currentUserId = null; // ID do Firebase (Anônimo)
        let currentSupervisor = null; // Objeto do supervisor logado
        let isMaster = false;
        let isSupervisor = false;
        let isRhUser = false;
        
        let globalSectors = []; // Armazena os setores carregados
        let globalEmployees = []; // Armazena os colaboradores carregados
        let globalHistory = []; // Armazena o histórico para o CSV e ordenação
        
        let currentSort = { column: 'createdAt', direction: 'desc' }; // Ordenação padrão
        let currentEditingLaunchId = null; // ID do lançamento sendo editado

        // --- Elementos da UI: Login ---
        const loginScreen = document.getElementById('login-screen');
        const appContent = document.getElementById('app-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');

        // --- Elementos da UI: Cabeçalho ---
        const btnViewLaunch = document.getElementById('btn-view-launch');
        const btnViewAdmin = document.getElementById('btn-view-admin');
        const btnLogout = document.getElementById('btn-logout');

        // --- Elementos da UI: Painel de Botões ---
        const adminControls = document.getElementById('admin-controls');
        const userIdLog = document.getElementById('user-id-log');
        const currentUserIdDisplay = document.getElementById('current-user-id-display');
        const btnOpenSupervisorModal = document.getElementById('btn-open-supervisor-modal');
        const btnOpenSectorModal = document.getElementById('btn-open-sector-modal');
        const btnOpenEmployeeModal = document.getElementById('btn-open-employee-modal');
        const btnManageSectorIndices = document.getElementById('btn-manage-sector-indices');
        const masterButtons = document.getElementById('master-buttons'); // Contêiner dos botões Master

        // --- Elementos da UI: Visões (Telas) ---
        const viewLaunch = document.getElementById('view-launch');
        const viewAdmin = document.getElementById('view-admin');

        // --- Elementos da UI: Abas (Painel de Gestão) ---
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- Elementos da UI: Formulário de Lançamento ---
        const launchForm = document.getElementById('launch-form');
        const monthRefInput = document.getElementById('month-ref');
        const sectorFilterContainer = document.getElementById('sector-filter-container');
        const sectorFilterSelect = document.getElementById('sector-filter');
        const baseValueInput = document.getElementById('base-value');
        const btnSaveBaseValue = document.getElementById('btn-save-base-value');
        const baseValueLoading = document.getElementById('base-value-loading');
        const supervisorLaunchFields = document.getElementById('supervisor-launch-fields');
        const employeeSelect = document.getElementById('employee-select');
        const indicesContainer = document.getElementById('indices-container');
        const totalCalculated = document.getElementById('total-calculated');
        const btnSubmitLaunch = document.getElementById('btn-submit-launch');
        const btnCancelEdit = document.getElementById('btn-cancel-edit');
        
        // --- Elementos da UI: Histórico ---
        const historyTable = document.getElementById('historyTable');
        const historyTableBody = document.getElementById('history-table-body');
        const historyLoading = document.getElementById('history-loading');
        const btnDownloadCSV = document.getElementById('btn-download-csv');
        const historyActionHeader = document.getElementById('history-action-header');

        // --- Elementos da UI: Modais ---
        const supervisorModal = document.getElementById('supervisor-modal');
        const supervisorForm = document.getElementById('supervisor-form');
        const supervisorModalTitle = document.getElementById('supervisor-modal-title');
        const supervisorSectorSelect = document.getElementById('supervisor-sector');
        const showPasswordSupervisor = document.getElementById('show-password-supervisor');

        const sectorModal = document.getElementById('sector-modal');
        const sectorForm = document.getElementById('sector-form');
        const sectorModalTitle = document.getElementById('sector-modal-title');
        const sectorNameInput = document.getElementById('sector-name');
        const btnSaveSector = document.getElementById('btn-save-sector');

        const indicesModal = document.getElementById('indices-modal');
        const indicesForm = document.getElementById('indices-form');
        const indicesSectorName = document.getElementById('indices-sector-name');
        const indicesList = document.getElementById('indices-list');
        const btnAddIndice = document.getElementById('btn-add-indice');
        const indicesTotalPercent = document.getElementById('indices-total-percent');
        const btnSaveIndices = document.getElementById('btn-save-indices');

        const employeeModal = document.getElementById('employee-modal');
        const employeeForm = document.getElementById('employee-form');
        const employeeModalTitle = document.getElementById('employee-modal-title');
        const employeeSectorSelect = document.getElementById('employee-sector');
        
        const deleteConfirmModal = document.getElementById('delete-confirm-modal');
        const deleteConfirmMessage = document.getElementById('delete-confirm-message');
        const btnDeleteConfirm = document.getElementById('btn-delete-confirm');

        const alertModal = document.getElementById('alert-modal');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const btnAlertOk = document.getElementById('btn-alert-ok');

        // --- Caminhos do Firestore ---
        const getSupervisorsCollection = () => collection(db, 'artifacts', appId, 'supervisors');
        const getSectorsCollection = () => collection(db, 'artifacts', appId, 'sectors');
        const getEmployeesCollection = () => collection(db, 'artifacts', appId, 'employees');
        const getHistoryCollection = () => collection(db, 'artifacts', appId, 'lancamentos');
        const getBaseValueDoc = (monthYear) => doc(db, 'artifacts', appId, 'baseValues', monthYear);

        // --- Inicialização ---

        // Função para mostrar aviso
        const showMessage = (title, message) => {
            alertModalTitle.textContent = title;
            alertModalMessage.textContent = message;
            alertModal.style.display = 'block';
        };
        
        btnAlertOk.addEventListener('click', () => {
            alertModal.style.display = 'none';
        });

        // Inicializa o Firebase
        async function startFirebase() {
            // Verifica se a config foi colada
            if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("COLE_SUA_API_KEY_AQUI")) {
                showMessage("Erro Crítico", "A 'firebaseConfig' não foi colada no arquivo index.html. Siga a 'Parte 4' do Guia de Publicação.");
                console.error("Configuração do Firebase ausente no index.html.");
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                setLogLevel('error'); // Reduz o spam no console

                // Tenta fazer login anônimo para obter um UID para logs
                await signInAnonymously(auth);
                
                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        currentUserId = user.uid;
                        if(currentUserIdDisplay) {
                            currentUserIdDisplay.textContent = currentUserId;
                        }
                    } else {
                        console.warn("Usuário anônimo não autenticado.");
                    }
                });

            } catch (error) {
                console.error("Erro ao inicializar o Firebase:", error);
                showMessage("Erro de Conexão", `Não foi possível conectar ao banco de dados: ${error.message}`);
            }
        }

        // --- Funções de Login e Permissões ---

        // Listener do formulário de login
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            loginError.classList.add('hidden');
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;

            let loggedIn = false;
            let supervisorData = null;

            // 1. Verificar se é o Admin Master
            if (username === 'admin' && password === '12345678') {
                loggedIn = true;
                isMaster = true;
                isSupervisor = false; // Master não é supervisor
                isRhUser = false;
                currentSupervisor = { name: 'Admin Master', sectorId: null, sectorName: 'Master' }; // Objeto genérico
            } else {
                // 2. Se não for Master, verificar no banco de dados de supervisores
                try {
                    const q = query(getSupervisorsCollection(), where("username", "==", username));
                    const querySnapshot = await getDocs(q);
                    
                    if (!querySnapshot.empty) {
                        const supervisorDoc = querySnapshot.docs[0];
                        supervisorData = supervisorDoc.data();
                        
                        // 3. Verificar a senha
                        if (supervisorData.password === password) {
                            loggedIn = true;
                            isMaster = false;
                            isSupervisor = true;
                            currentSupervisor = { id: supervisorDoc.id, ...supervisorData };
                            
                            // 4. Verificar se é RH
                            if (supervisorData.sectorName.toLowerCase() === 'rh') {
                                isRhUser = true;
                                isSupervisor = false; // RH é um perfil separado
                            } else {
                                isRhUser = false;
                            }
                        }
                    }
                } catch (error) {
                    console.error("Erro ao verificar supervisor:", error);
                    showMessage("Erro de Login", "Erro ao conectar ao banco de dados para verificar credenciais.");
                    return;
                }
            }

            // 5. Finalizar o login
            if (loggedIn) {
                finalizeLogin();
            } else {
                loginError.classList.remove('hidden');
            }
        });
        
        function finalizeLogin() {
            loginScreen.style.display = 'none';
            appContent.style.display = 'block';
            
            // Sempre reseta para a visão de lançamento ao logar
            switchView('launch'); 

            // Carrega os dados essenciais
            loadSectors();
            loadEmployees();
            
            // Define o mês padrão e carrega o histórico
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            const defaultMonth = `${year}-${month}`;
            monthRefInput.value = defaultMonth;
            
            loadBaseValue(defaultMonth); // Carrega o valor base para o mês padrão
            loadHistory(defaultMonth); // Carrega o histórico para o mês padrão
            
            // Aplica as permissões (agora que o login está completo)
            // Esta função NÃO depende mais do loadSectors
            applyPermissions();
        }

        // Aplica as permissões visuais com base no perfil
        function applyPermissions() {
            if (!adminControls || !btnViewAdmin) {
                console.error("Elementos de UI faltando, não é possível aplicar permissões.");
                return; // Impede o erro de 'null'
            }

            // Esconde tudo por padrão
            adminControls.classList.add('hidden');
            btnViewAdmin.classList.add('hidden');
            btnOpenSupervisorModal.classList.add('hidden');
            btnOpenSectorModal.classList.add('hidden');
            btnOpenEmployeeModal.classList.add('hidden');
            btnManageSectorIndices.classList.add('hidden');
            supervisorLaunchFields.classList.add('hidden');
            btnSaveBaseValue.classList.add('hidden');
            sectorFilterContainer.classList.add('hidden');
            if (historyActionHeader) historyActionHeader.classList.add('hidden');
            
            // Esconde a coluna Ação (segurança extra)
            document.querySelectorAll('.history-action-cell').forEach(cell => cell.classList.add('hidden'));


            if (isMaster) {
                adminControls.classList.remove('hidden');
                btnViewAdmin.classList.remove('hidden');
                btnOpenSupervisorModal.classList.remove('hidden');
                btnOpenSectorModal.classList.remove('hidden');
                btnOpenEmployeeModal.classList.remove('hidden'); // Master pode cadastrar colaborador em qualquer setor
                
                // Master pode definir valor base
                baseValueInput.readOnly = false;
                btnSaveBaseValue.classList.remove('hidden');
                
                // Master pode filtrar por setor
                sectorFilterContainer.classList.remove('hidden');
                
                // Limpa o formulário de lançamento (Master não lança)
                supervisorLaunchFields.style.display = 'none';

            } else if (isSupervisor) {
                adminControls.classList.remove('hidden');
                btnOpenEmployeeModal.classList.remove('hidden');
                btnManageSectorIndices.classList.remove('hidden');
                supervisorLaunchFields.classList.remove('hidden');
                if (historyActionHeader) historyActionHeader.classList.remove('hidden');
                
                document.querySelectorAll('.history-action-cell').forEach(cell => cell.classList.remove('hidden'));

            } else if (isRhUser) {
                adminControls.classList.remove('hidden'); // Mostra o painel, mas sem botões
                // RH pode filtrar por setor
                sectorFilterContainer.classList.remove('hidden');
                // RH não lança
                supervisorLaunchFields.style.display = 'none';
            }
        }
        
        // Botão de Sair
        btnLogout.addEventListener('click', () => {
            // Recarrega a página para forçar o login
            window.location.reload();
        });

        // --- Funções de Navegação (Abas e Visões) ---
        
        // Alterna entre "Lançamento" e "Painel de Gestão"
        function switchView(viewName) {
            if (viewName === 'admin') {
                viewLaunch.style.display = 'none';
                viewAdmin.style.display = 'block';
                btnViewAdmin.classList.add('text-red-600', 'font-semibold');
                btnViewLaunch.classList.remove('text-red-600', 'font-semibold');
                
                // Carrega (ou recarrega) as tabelas do admin
                loadAdminTables();

            } else { // 'launch'
                viewLaunch.style.display = 'grid'; // 'grid' para layout lado a lado
                viewAdmin.style.display = 'none';
                btnViewLaunch.classList.add('text-red-600', 'font-semibold');
                btnViewAdmin.classList.remove('text-red-600', 'font-semibold');
            }
        }

        btnViewLaunch.addEventListener('click', () => switchView('launch'));
        btnViewAdmin.addEventListener('click', () => switchView('admin'));

        // Alterna as abas no Painel de Gestão
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.getAttribute('data-tab');
                
                tabButtons.forEach(btn => btn.classList.remove('active'));
                button.classList.add('active');
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`tab-${tabId}`).classList.add('active');
            });
        });
        
        function loadAdminTables() {
            // Carrega os dados das 3 tabelas do painel
            renderSupervisorsTable();
            renderSectorsTable();
            renderEmployeesTable();
        }

        // --- Funções de Carregamento de Dados (Firestore Listeners) ---

        // Carrega (e ouve) SETORES
        function loadSectors() {
            try {
                onSnapshot(getSectorsCollection(), (snapshot) => {
                    globalSectors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    globalSectors.sort((a, b) => a.name.localeCompare(b.name));
                    
                    // Atualiza todos os <select> de setor
                    updateSectorSelects();
                    
                }, (error) => {
                    console.error("Erro ao carregar setores: ", error);
                    showMessage("Erro de Leitura", "Não foi possível carregar os setores.");
                    // IMPORTANTE: Aplicar permissões mesmo se o load falhar,
                    // caso contrário o Admin Master não vê os botões para CRIAR o primeiro setor.
                    applyPermissions();
                });
            } catch(e) {
                console.error("Erro crítico no listener de setores:", e);
                applyPermissions(); // Garante que os botões apareçam mesmo em erro
            }
        }

        // Carrega (e ouve) COLABORADORES
        function loadEmployees() {
            let q = getEmployeesCollection();
            
            // Se for Supervisor (não-RH), filtra colaboradores pelo setor dele
            if (isSupervisor && !isRhUser && currentSupervisor.sectorId) {
                q = query(getEmployeesCollection(), where("sectorId", "==", currentSupervisor.sectorId));
            }
            
            onSnapshot(q, (snapshot) => {
                globalEmployees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                globalEmployees.sort((a, b) => a.name.localeCompare(b.name));
                
                // Atualiza o <select> de colaborador (no formulário de lançamento)
                updateEmployeeSelect();
                
            }, (error) => {
                console.error("Erro ao carregar colaboradores: ", error);
                showMessage("Erro de Leitura", "Não foi possível carregar os colaboradores.");
            });
        }
        
        // Carrega (e ouve) o VALOR BASE do mês
        function loadBaseValue(monthYear) {
            if (!monthYear) {
                baseValueInput.value = '';
                return;
            }
            baseValueLoading.classList.remove('hidden');
            baseValueInput.classList.add('hidden');
            
            try {
                const docRef = getBaseValueDoc(monthYear);
                onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        baseValueInput.value = docSnap.data().value;
                    } else {
                        baseValueInput.value = ''; // Limpa se não houver valor salvo
                    }
                    baseValueLoading.classList.add('hidden');
                    baseValueInput.classList.remove('hidden');
                }, (error) => {
                    console.error("Erro ao carregar valor base: ", error);
                    baseValueLoading.classList.add('hidden');
                    baseValueInput.classList.remove('hidden');
                });
            } catch (error) {
                 console.error("Erro crítico no listener do valor base: ", error);
                 baseValueLoading.classList.add('hidden');
                 baseValueInput.classList.remove('hidden');
            }
        }

        // Carrega (e ouve) o HISTÓRICO
        let unsubscribeHistory = null; // Variável para guardar a função de "parar de ouvir"
        
        function loadHistory(monthYear, sectorId = 'all') {
            // 1. Para de "ouvir" o histórico anterior (se houver)
            if (unsubscribeHistory) {
                unsubscribeHistory();
            }

            historyTableBody.innerHTML = ''; // Limpa a tabela
            historyLoading.classList.remove('hidden'); // Mostra "Carregando..."
            globalHistory = []; // Limpa o array global

            if (!monthYear) {
                historyLoading.innerHTML = '<td colspan="8" class="text-center py-6 text-gray-500">Selecione um mês para ver o histórico.</td>';
                return;
            }
            
            try {
                // 2. Cria a nova query (consulta)
                let constraints = [where("monthRef", "==", monthYear)];
                
                // Se for Supervisor (não-RH), filtra pelo setor dele
                if (isSupervisor && !isRhUser) {
                    constraints.push(where("sectorId", "==", currentSupervisor.sectorId));
                } 
                // Se for Master/RH e selecionou um setor específico
                else if ((isMaster || isRhUser) && sectorId !== 'all') {
                    constraints.push(where("sectorId", "==", sectorId));
                }
                
                const q = query(getHistoryCollection(), ...constraints);

                // 3. Começa a "ouvir" a nova consulta
                unsubscribeHistory = onSnapshot(q, (snapshot) => {
                    globalHistory = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    
                    // Aplica a ordenação atual
                    sortHistory();
                    renderHistoryTable(); // Desenha a tabela
                    
                }, (error) => {
                    console.error("Erro ao carregar histórico: ", error);
                    historyLoading.innerHTML = '<td colspan="8" class="text-center py-6 text-red-500">Erro ao carregar histórico.</td>';
                });

            } catch(e) {
                 console.error("Erro crítico no listener de histórico: ", e);
                 historyLoading.innerHTML = '<td colspan="8" class="text-center py-6 text-red-500">Erro crítico ao buscar dados.</td>';
            }
        }
        
        // --- Funções de Renderização (Desenhar na Tela) ---

        // (Re)Desenha o <select> de setores
        function updateSectorSelects() {
            const selects = [supervisorSectorSelect, employeeSectorSelect, sectorFilterSelect];
            
            // Guarda o valor que estava selecionado (para não perder ao atualizar)
            const oldValues = selects.map(s => s ? s.value : null);

            // Limpa as opções (mantendo a primeira)
            selects.forEach(select => {
                if (select) {
                    while (select.options.length > 1) {
                        select.remove(1);
                    }
                }
            });

            // Adiciona os setores carregados
            globalSectors.forEach(sector => {
                const option = new Option(sector.name, sector.id);
                const option2 = new Option(sector.name, sector.id);
                const option3 = new Option(sector.name, sector.id);
                
                if (supervisorSectorSelect) supervisorSectorSelect.add(option);
                if (employeeSectorSelect) employeeSectorSelect.add(option2);
                if (sectorFilterSelect) sectorFilterSelect.add(option3);
            });
            
            // Restaura os valores antigos (se ainda existirem)
            selects.forEach((select, index) => {
                if(select && oldValues[index]) {
                    select.value = oldValues[index];
                }
            });
        }
        
        // (Re)Desenha o <select> de colaboradores
        function updateEmployeeSelect() {
            const oldValue = employeeSelect.value;
            while (employeeSelect.options.length > 1) {
                employeeSelect.remove(1);
            }
            
            globalEmployees.forEach(emp => {
                // Adiciona o nome do setor ao lado do nome (se não for óbvio)
                const empName = (isMaster || isRhUser) ? `${emp.name} (${emp.sectorName})` : emp.name;
                const option = new Option(empName, emp.id);
                employeeSelect.add(option);
            });
            
            employeeSelect.value = oldValue;
        }
        
        // Desenha os campos de pontuação (índices)
        function renderIndices(employeeId) {
            indicesContainer.innerHTML = ''; // Limpa
            indicesContainer.classList.remove('grid-layout');

            if (!employeeId) {
                indicesContainer.innerHTML = '<p class="text-sm text-gray-500">Selecione um colaborador para ver os índices de pontuação.</p>';
                calculateTotal();
                return;
            }

            const employee = globalEmployees.find(e => e.id === employeeId);
            if (!employee) {
                indicesContainer.innerHTML = '<p class="text-sm text-red-500">Erro: Colaborador não encontrado.</p>';
                return;
            }
            
            const sector = globalSectors.find(s => s.id === employee.sectorId);
            if (!sector || !sector.indices || sector.indices.length === 0) {
                indicesContainer.innerHTML = '<p class="text-sm text-gray-500">Setor sem índices definidos. Peça ao seu supervisor para cadastrá-los.</p>';
                return;
            }

            // Adiciona layout em grid
            indicesContainer.classList.add('grid-layout');
            
            sector.indices.forEach((indice, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'indice-item';
                
                const label = document.createElement('label');
                label.htmlFor = `indice-${index}`;
                label.textContent = `${indice.name} (Max: ${indice.percent}%)`;
                
                const input = document.createElement('input');
                input.type = 'number';
                input.id = `indice-${index}`;
                input.className = 'indice-input';
                input.placeholder = `0 - ${indice.percent}`;
                input.setAttribute('data-max', indice.percent);
                input.setAttribute('data-name', indice.name); // Guarda o nome
                
                // Trava para não passar do máximo
                input.addEventListener('input', (e) => {
                    let value = parseFloat(e.target.value);
                    const max = parseFloat(e.target.getAttribute('data-max'));
                    if (value > max) {
                        e.target.value = max;
                    }
                    if (value < 0) {
                        e.target.value = 0;
                    }
                    calculateTotal();
                });

                itemDiv.appendChild(label);
                itemDiv.appendChild(input);
                indicesContainer.appendChild(itemDiv);
            });
            
            calculateTotal(); // Calcula o total (que será 0)
        }
        
        // Desenha a tabela do Histórico (com dados já carregados e ordenados)
        function renderHistoryTable() {
            // Limpa a tabela (mantendo o cabeçalho)
            historyTableBody.innerHTML = ''; 
            
            if (globalHistory.length === 0) {
                historyLoading.classList.remove('hidden');
                historyLoading.innerHTML = `<td colspan="8" class="text-center py-6 text-gray-500">Nenhum lançamento encontrado para este mês.</td>`;
            } else {
                historyLoading.classList.add('hidden');
                
                globalHistory.forEach(item => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    
                    const totalVal = parseFloat(item.totalValue || 0);
                    const baseVal = parseFloat(item.baseValue || 0);

                    // Formata a data (se existir)
                    let formattedDate = 'Data inválida';
                    if (item.createdAt && typeof item.createdAt.toDate === 'function') {
                         formattedDate = item.createdAt.toDate().toLocaleString('pt-BR', {
                            day: '2-digit',
                            month: '2-digit',
                            year: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                    }
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm text-gray-700">${item.monthRef}</td>
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${item.employeeName}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${item.sectorName}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">R$ ${baseVal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm font-bold ${totalVal < (baseVal * 0.9) ? 'text-red-600' : 'text-green-600'}">R$ ${totalVal.toFixed(2)}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${formattedDate}</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="btn-toggle-details text-blue-600 hover:text-blue-800 font-medium" data-id="${item.id}">Ver +</button>
                        </td>
                        <td class="history-action-cell px-4 py-3 text-sm text-center">
                            <button class="btn-edit-launch text-blue-600 hover:text-blue-800 font-medium mr-3" data-id="${item.id}">Editar</button>
                            <button class="btn-delete-launch text-red-600 hover:text-red-800 font-medium" data-id="${item.id}">Excluir</button>
                        </td>
                    `;
                    historyTableBody.appendChild(row);
                    
                    // Linha de Detalhes (oculta)
                    const detailsRow = document.createElement('tr');
                    detailsRow.id = `details-${item.id}`;
                    detailsRow.className = 'history-details-row hidden'; // Oculta por padrão
                    
                    const detailsCell = document.createElement('td');
                    detailsCell.colSpan = 8; // Ocupa todas as colunas
                    
                    const scoresHtml = item.scores.map(s => `
                        <li class="text-sm">
                            <span class="font-medium">${s.name}:</span> 
                            <span>${s.score} / ${s.max}</span>
                        </li>
                    `).join('');
                    
                    detailsCell.innerHTML = `
                        <div>
                            <p class="font-semibold mb-1">Pontuações Detalhadas:</p>
                            <ul class="list-disc list-inside space-y-1">${scoresHtml}</ul>
                        </div>
                    `;
                    
                    detailsRow.appendChild(detailsCell);
                    historyTableBody.appendChild(detailsRow);
                });
            }
            
            // Aplica as permissões de visualização (para esconder a coluna Ação se necessário)
            applyPermissions();
        }

        // --- Funções de Ordenação (Tabela de Histórico) ---
        
        // Adiciona listeners aos cabeçalhos da tabela
        historyTable.querySelectorAll('thead th[data-sort]').forEach(header => {
            header.addEventListener('click', () => {
                const column = header.getAttribute('data-sort');
                if (column === 'details' || column === 'action') return; // Não ordena por detalhes/ação

                if (currentSort.column === column) {
                    // Inverte a direção
                    currentSort.direction = (currentSort.direction === 'asc') ? 'desc' : 'asc';
                } else {
                    // Nova coluna
                    currentSort.column = column;
                    currentSort.direction = 'asc';
                }
                
                // Atualiza setas
                historyTable.querySelectorAll('thead .sort-arrow').forEach(arrow => {
                    arrow.classList.remove('active', 'asc', 'desc');
                    arrow.innerHTML = '';
                });
                const currentArrow = header.querySelector('.sort-arrow');
                currentArrow.classList.add('active', currentSort.direction);
                currentArrow.innerHTML = (currentSort.direction === 'asc') ? '&#9650;' : '&#9660;'; // ▲ ou ▼

                sortHistory();
                renderHistoryTable();
            });
        });

        // Ordena o array global `globalHistory`
        function sortHistory() {
            globalHistory.sort((a, b) => {
                let valA = a[currentSort.column];
                let valB = b[currentSort.column];
                
                // Converte tipos para ordenação correta
                if (currentSort.column === 'baseValue' || currentSort.column === 'totalValue') {
                    valA = parseFloat(valA || 0);
                    valB = parseFloat(valB || 0);
                } else if (currentSort.column === 'createdAt') {
                    valA = a.createdAt ? a.createdAt.toMillis() : 0;
                    valB = b.createdAt ? b.createdAt.toMillis() : 0;
                } else {
                    valA = (valA || '').toString().toLowerCase();
                    valB = (valB || '').toString().toLowerCase();
                }

                if (valA < valB) {
                    return currentSort.direction === 'asc' ? -1 : 1;
                }
                if (valA > valB) {
                    return currentSort.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }
        
        // --- Funções de Interação (Formulários, Botões) ---
        
        // Calcula o total da remuneração no formulário
        function calculateTotal() {
            const baseValue = parseFloat(baseValueInput.value) || 0;
            let totalScore = 0;
            
            const inputs = indicesContainer.querySelectorAll('.indice-input');
            if (inputs.length === 0) {
                totalCalculated.textContent = "R$ 0,00";
                return 0;
            }

            inputs.forEach(input => {
                totalScore += parseFloat(input.value) || 0;
            });

            // A pontuação total (soma dos scores) é aplicada como percentual do valor base
            const totalVariable = baseValue * (totalScore / 100);
            
            totalCalculated.textContent = `R$ ${totalVariable.toFixed(2)}`;
            return totalVariable;
        }

        // Salva (ou atualiza) um lançamento
        async function handleSave(e) {
            e.preventDefault();
            if (!isSupervisor || isRhUser) {
                showMessage("Acesso Negado", "Apenas supervisores podem lançar remunerações.");
                return;
            }

            // Validação
            const monthRef = monthRefInput.value;
            const employeeId = employeeSelect.value;
            const baseValue = parseFloat(baseValueInput.value);
            
            if (!monthRef) {
                showMessage("Campo Obrigatório", "Por favor, selecione o Mês de Referência.");
                return;
            }
            if (!employeeId) {
                showMessage("Campo Obrigatório", "Por favor, selecione um Colaborador.");
                return;
            }
            if (isNaN(baseValue) || baseValue <= 0) {
                showMessage("Valor Inválido", "O Valor Base para este mês é inválido ou não foi definido pelo Master.");
                return;
            }
            
            const employee = globalEmployees.find(e => e.id === employeeId);
            const sector = globalSectors.find(s => s.id === employee.sectorId);
            
            if (!employee || !sector) {
                 showMessage("Erro de Dados", "Colaborador ou Setor não encontrado.");
                 return;
            }

            // Coleta as pontuações
            const scores = [];
            const inputs = indicesContainer.querySelectorAll('.indice-input');
            if (inputs.length === 0) {
                 showMessage("Erro de Índices", "Este setor não possui índices de pontuação definidos.");
                 return;
            }
            
            inputs.forEach(input => {
                scores.push({
                    name: input.getAttribute('data-name'),
                    score: parseFloat(input.value) || 0,
                    max: parseFloat(input.getAttribute('data-max'))
                });
            });
            
            const totalValue = calculateTotal();
            
            const launchData = {
                monthRef: monthRef,
                employeeId: employeeId,
                employeeName: employee.name,
                sectorId: sector.id,
                sectorName: sector.name,
                baseValue: baseValue,
                totalValue: totalValue,
                scores: scores,
                launchedBy: currentUserId, // Log do usuário anônimo
                launchedBySupervisor: currentSupervisor.name, // Nome do supervisor
                createdAt: serverTimestamp() // Data/hora do servidor
            };
            
            btnSubmitLaunch.disabled = true;
            btnSubmitLaunch.textContent = "Salvando...";
            
            try {
                if (currentEditingLaunchId) {
                    // Atualiza um lançamento existente
                    const docRef = doc(db, 'artifacts', appId, 'lancamentos', currentEditingLaunchId);
                    // Remove 'createdAt' para não sobrescrever a data original
                    delete launchData.createdAt; 
                    
                    await updateDoc(docRef, launchData);
                    showMessage("Sucesso!", "Lançamento atualizado com sucesso!");
                } else {
                    // Salva um novo lançamento
                    await addDoc(getHistoryCollection(), launchData);
                    showMessage("Sucesso!", "Remuneração lançada com sucesso!");
                }
                
                // Limpa o formulário
                launchForm.reset();
                indicesContainer.innerHTML = '<p class="text-sm text-gray-500">Selecione um colaborador para ver os índices de pontuação.</p>';
                indicesContainer.classList.remove('grid-layout');
                totalCalculated.textContent = "R$ 0,00";
                
                // Reseta o modo de edição
                cancelEditMode();

            } catch (error) {
                console.error("Erro ao salvar lançamento: ", error);
                showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            } finally {
                btnSubmitLaunch.disabled = false;
                btnSubmitLaunch.textContent = "Lançar Remuneração";
            }
        }
        
        launchForm.addEventListener('submit', handleSave);
        
        // Salva o Valor Base (Admin Master)
        btnSaveBaseValue.addEventListener('click', async () => {
            if (!isMaster) return;
            
            const monthYear = monthRefInput.value;
            const value = parseFloat(baseValueInput.value);

            if (!monthYear) {
                showMessage("Mês Inválido", "Por favor, selecione um Mês de Referência para salvar o valor.");
                return;
            }
             if (isNaN(value) || value < 0) {
                showMessage("Valor Inválido", "Por favor, insira um valor numérico válido.");
                return;
            }
            
            try {
                const docRef = getBaseValueDoc(monthYear);
                await setDoc(docRef, { value: value });
                showMessage("Sucesso", `Valor Base (R$ ${value.toFixed(2)}) salvo para ${monthYear}.`);
            } catch (error) {
                console.error("Erro ao salvar Valor Base: ", error);
                showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            }
        });

        // --- Funções de Edição/Exclusão do Histórico ---

        // Delega eventos na tabela de histórico
        historyTableBody.addEventListener('click', (e) => {
            // Botão "Ver +" (Detalhes)
            if (e.target.classList.contains('btn-toggle-details')) {
                const id = e.target.getAttribute('data-id');
                const detailsRow = document.getElementById(`details-${id}`);
                if (detailsRow) {
                    detailsRow.classList.toggle('hidden');
                    e.target.textContent = detailsRow.classList.contains('hidden') ? 'Ver +' : 'Ocultar';
                }
            }
            
            // Botão "Editar"
            if (e.target.classList.contains('btn-edit-launch')) {
                const id = e.target.getAttribute('data-id');
                loadLaunchForEdit(id);
            }
            
            // Botão "Excluir"
            if (e.target.classList.contains('btn-delete-launch')) {
                const id = e.target.getAttribute('data-id');
                const launch = globalHistory.find(item => item.id === id);
                if (launch) {
                    openDeleteModal('launch', id, `o lançamento de ${launch.employeeName} (R$ ${launch.totalValue.toFixed(2)})`);
                }
            }
        });
        
        // Carrega um lançamento no formulário para edição
        function loadLaunchForEdit(launchId) {
            const launch = globalHistory.find(item => item.id === launchId);
            if (!launch) {
                showMessage("Erro", "Lançamento não encontrado.");
                return;
            }
            
            // Entra no modo de edição
            currentEditingLaunchId = launchId;
            btnSubmitLaunch.textContent = "Salvar Alterações";
            btnSubmitLaunch.classList.replace('bg-red-600', 'bg-yellow-500');
            btnSubmitLaunch.classList.replace('hover:bg-red-700', 'hover:bg-yellow-600');
            btnCancelEdit.classList.remove('hidden');
            
            // Preenche o formulário
            monthRefInput.value = launch.monthRef;
            baseValueInput.value = launch.baseValue;
            
            // Seleciona o colaborador (e espera os índices renderizarem)
            employeeSelect.value = launch.employeeId;
            renderIndices(launch.employeeId);
            
            // Atraso para garantir que os inputs de índice existam
            setTimeout(() => {
                // Preenche as pontuações
                const inputs = indicesContainer.querySelectorAll('.indice-input');
                inputs.forEach(input => {
                    const inputName = input.getAttribute('data-name');
                    const scoreData = launch.scores.find(s => s.name === inputName);
                    if (scoreData) {
                        input.value = scoreData.score;
                    }
                });
                // Recalcula o total
                calculateTotal();
            }, 100); // 100ms de espera
            
            // Rola a tela para o topo
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        
        // Cancela o modo de edição
        function cancelEditMode() {
            currentEditingLaunchId = null;
            btnSubmitLaunch.textContent = "Lançar Remuneração";
            btnSubmitLaunch.classList.replace('bg-yellow-500', 'bg-red-600');
            btnSubmitLaunch.classList.replace('hover:bg-yellow-600', 'hover:bg-red-700');
            btnCancelEdit.classList.add('hidden');
            
            // Limpa o formulário
            launchForm.reset();
            indicesContainer.innerHTML = '<p class="text-sm text-gray-500">Selecione um colaborador para ver os índices de pontuação.</p>';
            indicesContainer.classList.remove('grid-layout');
            totalCalculated.textContent = "R$ 0,00";
            
            // Reseta o mês para o padrão (pode ter sido alterado na edição)
            const now = new Date();
            const year = now.getFullYear();
            const month = (now.getMonth() + 1).toString().padStart(2, '0');
            monthRefInput.value = `${year}-${month}`;
            loadBaseValue(monthRefInput.value);
        }
        btnCancelEdit.addEventListener('click', cancelEditMode);


        // --- Listeners de Eventos (Filtros) ---
        
        // Filtra histórico e valor base ao mudar o MÊS
        monthRefInput.addEventListener('change', () => {
            const newMonth = monthRefInput.value;
            const currentSectorFilter = sectorFilterSelect.value;
            loadHistory(newMonth, currentSectorFilter);
            loadBaseValue(newMonth);
        });
        
        // Filtra histórico ao mudar o SETOR (Master/RH)
        sectorFilterSelect.addEventListener('change', () => {
            const newMonth = monthRefInput.value;
            const currentSectorFilter = sectorFilterSelect.value;
            loadHistory(newMonth, currentSectorFilter);
        });

        // Carrega índices ao mudar o COLABORADOR
        employeeSelect.addEventListener('change', () => {
            renderIndices(employeeSelect.value);
        });
        
        // Recalcula total ao digitar no Valor Base (Master)
        baseValueInput.addEventListener('input', () => {
            if (isMaster) {
                calculateTotal();
            }
        });
        
        // --- Funções do Painel de Gestão (Master) ---

        // Renderiza Tabela de SUPERVISORES
        function renderSupervisorsTable() {
            const tableBody = document.getElementById('supervisors-table-body');
            tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">Carregando...</td></tr>';
            
            try {
                onSnapshot(getSupervisorsCollection(), (snapshot) => {
                    const supervisors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    tableBody.innerHTML = '';
                    
                    if (supervisors.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-gray-500">Nenhum supervisor cadastrado.</td></tr>';
                        return;
                    }
                    
                    supervisors.sort((a,b) => a.name.localeCompare(b.name));
                    
                    supervisors.forEach(sup => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${sup.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${sup.username}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${sup.sectorName}</td>
                            <td class="px-4 py-3 text-sm">
                                <button class="btn-edit-supervisor text-blue-600 hover:text-blue-800 font-medium mr-3" data-id="${sup.id}">Editar</button>
                                <button class="btn-delete-supervisor text-red-600 hover:text-red-800 font-medium" data-id="${sup.id}">Excluir</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }, (error) => {
                    console.error("Erro ao carregar supervisores: ", error);
                    tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-red-500">Erro ao carregar supervisores: ${error.message}</td></tr>`;
                });
            } catch (e) {
                 console.error("Erro crítico no listener de supervisores: ", e);
                 tableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6 text-red-500">Erro crítico: ${e.message}</td></tr>`;
            }
        }
        
        // Renderiza Tabela de SETORES
        function renderSectorsTable() {
            const tableBody = document.getElementById('sectors-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Carregando...</td></tr>';
            
            try {
                // Usa o globalSectors que já está sendo ouvido
                tableBody.innerHTML = '';
                
                if (globalSectors.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Nenhum setor cadastrado.</td></tr>';
                    return;
                }
                
                globalSectors.forEach(sector => {
                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-50';
                    const indicesCount = sector.indices ? sector.indices.length : 0;
                    
                    row.innerHTML = `
                        <td class="px-4 py-3 text-sm font-medium text-gray-900">${sector.name}</td>
                        <td class="px-4 py-3 text-sm text-gray-700">${indicesCount} índice(s) definido(s)</td>
                        <td class="px-4 py-3 text-sm">
                            <button class="btn-delete-sector text-red-600 hover:text-red-800 font-medium" data-id="${sector.id}">Excluir</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (e) {
                 console.error("Erro ao renderizar setores: ", e);
                 tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-red-500">Erro crítico: ${e.message}</td></tr>`;
            }
        }
        
        // Renderiza Tabela de COLABORADORES
        function renderEmployeesTable() {
            const tableBody = document.getElementById('employees-table-body');
            tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Carregando...</td></tr>';
            
            try {
                // Usa o globalEmployees que já está sendo ouvido (se for Master/RH)
                // Se for Supervisor, precisamos carregar TODOS para o painel de gestão
                let querySource = getEmployeesCollection();
                
                onSnapshot(querySource, (snapshot) => {
                    const employees = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    tableBody.innerHTML = '';
                    
                    if (employees.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="3" class="text-center py-6 text-gray-500">Nenhum colaborador cadastrado.</td></tr>';
                        return;
                    }
                    
                    employees.sort((a,b) => a.name.localeCompare(b.name));
                    
                    employees.forEach(emp => {
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-50';
                        row.innerHTML = `
                            <td class="px-4 py-3 text-sm font-medium text-gray-900">${emp.name}</td>
                            <td class="px-4 py-3 text-sm text-gray-700">${emp.sectorName}</td>
                            <td class="px-4 py-3 text-sm">
                                <button class="btn-edit-employee text-blue-600 hover:text-blue-800 font-medium mr-3" data-id="${emp.id}">Editar</button>
                                <button class="btn-delete-employee text-red-600 hover:text-red-800 font-medium" data-id="${emp.id}">Excluir</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                }, (error) => {
                     console.error("Erro ao carregar colaboradores (Admin): ", error);
                     tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-red-500">Erro ao carregar colaboradores: ${error.message}</td></tr>`;
                });
            } catch (e) {
                 console.error("Erro crítico no listener de colaboradores (Admin): ", e);
                 tableBody.innerHTML = `<tr><td colspan="3" class="text-center py-6 text-red-500">Erro crítico: ${e.message}</td></tr>`;
            }
        }


        // --- Funções de Abertura/Fechamento de Modais ---
        
        const openModal = (modalElement) => modalElement.style.display = 'block';
        const closeModal = (modalElement) => modalElement.style.display = 'none';

        // Fechar modais (botões 'x' e 'cancelar')
        document.querySelectorAll('.close, .btn-cancel').forEach(btn => {
            btn.addEventListener('click', () => {
                const modalId = btn.getAttribute('data-modal');
                if (modalId) {
                    closeModal(document.getElementById(modalId));
                }
            });
        });
        
        // Fechar modal clicando fora
        window.onclick = (event) => {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        };

        // Abrir Modal SUPERVISOR
        btnOpenSupervisorModal.addEventListener('click', () => {
            supervisorForm.reset();
            supervisorModalTitle.textContent = "Cadastrar Novo Supervisor";
            document.getElementById('edit-supervisor-id').value = '';
            document.getElementById('supervisor-password').required = true;
            openModal(supervisorModal);
        });
        
        // Abrir Modal SETOR (Master)
        btnOpenSectorModal.addEventListener('click', () => {
            sectorForm.reset();
            sectorModalTitle.textContent = "Cadastrar Novo Setor";
            document.getElementById('edit-sector-id').value = '';
            btnSaveSector.disabled = false;
            openModal(sectorModal);
        });

        // Abrir Modal METAS (Supervisor)
        btnManageSectorIndices.addEventListener('click', () => {
            const sector = globalSectors.find(s => s.id === currentSupervisor.sectorId);
            if (!sector) {
                showMessage("Erro", "Setor do supervisor não encontrado.");
                return;
            }
            
            indicesForm.reset();
            indicesList.innerHTML = '';
            document.getElementById('edit-indices-sector-id').value = sector.id;
            indicesSectorName.value = sector.name;

            // Preenche os índices existentes
            let total = 0;
            if (sector.indices && sector.indices.length > 0) {
                sector.indices.forEach(indice => {
                    addIndiceRow(indice.name, indice.percent);
                    total += parseFloat(indice.percent) || 0;
                });
            } else {
                addIndiceRow(); // Adiciona uma linha em branco
            }
            updateIndicesTotal();
            openModal(indicesModal);
        });

        // Abrir Modal COLABORADOR
        btnOpenEmployeeModal.addEventListener('click', () => {
            employeeForm.reset();
            employeeModalTitle.textContent = "Cadastrar Novo Colaborador";
            document.getElementById('edit-employee-id').value = '';
            
            // Lógica para Supervisor (trava o setor)
            if (isSupervisor && !isRhUser) {
                employeeSectorSelect.value = currentSupervisor.sectorId;
                employeeSectorSelect.disabled = true;
            } else {
                employeeSectorSelect.disabled = false;
            }
            
            openModal(employeeModal);
        });

        // Abrir Modal de EXCLUSÃO (genérico)
        let deleteCallback = null;
        function openDeleteModal(type, id, name) {
            deleteConfirmMessage.textContent = `Você tem certeza que deseja excluir "${name}"? Esta ação não pode ser desfeita.`;
            
            deleteCallback = async () => {
                try {
                    let docRef;
                    if (type === 'supervisor') {
                        docRef = doc(db, 'artifacts', appId, 'supervisors', id);
                    } else if (type === 'sector') {
                        docRef = doc(db, 'artifacts', appId, 'sectors', id);
                        await checkAndDeleteSector(id, name); // Função especial para setor
                        return; // checkAndDeleteSector já lida com a exclusão
                    } else if (type === 'employee') {
                        docRef = doc(db, 'artifacts', appId, 'employees', id);
                    } else if (type === 'launch') {
                         docRef = doc(db, 'artifacts', appId, 'lancamentos', id);
                    } else {
                        throw new Error("Tipo de exclusão desconhecido.");
                    }
                    
                    await deleteDoc(docRef);
                    showMessage("Sucesso", `"${name}" foi excluído.`);
                
                } catch (error) {
                    console.error("Erro ao excluir: ", error);
                    showMessage("Erro", `Não foi possível excluir: ${error.message}`);
                } finally {
                    closeModal(deleteConfirmModal);
                    deleteCallback = null;
                }
            };
            
            openModal(deleteConfirmModal);
        }
        
        btnDeleteConfirm.addEventListener('click', () => {
            if (deleteCallback) {
                deleteCallback();
            }
        });
        
        // Verifica se um setor pode ser excluído (se não há supervisores ou colaboradores nele)
        async function checkAndDeleteSector(sectorId, sectorName) {
            try {
                // 1. Verifica supervisores
                const supQuery = query(getSupervisorsCollection(), where("sectorId", "==", sectorId));
                const supSnapshot = await getDocs(supQuery);
                if (!supSnapshot.empty) {
                    showMessage("Ação Bloqueada", `Não é possível excluir o setor "${sectorName}" pois ele está atribuído a um supervisor. Remova o supervisor do setor primeiro.`);
                    closeModal(deleteConfirmModal);
                    return;
                }
                
                // 2. Verifica colaboradores
                const empQuery = query(getEmployeesCollection(), where("sectorId", "==", sectorId));
                const empSnapshot = await getDocs(empQuery);
                if (!empSnapshot.empty) {
                     showMessage("Ação Bloqueada", `Não é possível excluir o setor "${sectorName}" pois ele contém colaboradores. Remova os colaboradores do setor primeiro.`);
                     closeModal(deleteConfirmModal);
                    return;
                }
                
                // 3. Exclui os lançamentos (em lote)
                const launchQuery = query(getHistoryCollection(), where("sectorId", "==", sectorId));
                const launchSnapshot = await getDocs(launchQuery);
                if (!launchSnapshot.empty) {
                    const batch = writeBatch(db);
                    launchSnapshot.docs.forEach(doc => batch.delete(doc.ref));
                    await batch.commit();
                }
                
                // 4. Exclui o setor
                const docRef = doc(db, 'artifacts', appId, 'sectors', sectorId);
                await deleteDoc(docRef);
                
                showMessage("Sucesso", `Setor "${sectorName}" e ${launchSnapshot.size} lançamento(s) associado(s) foram excluídos.`);

            } catch (error) {
                 console.error("Erro ao excluir setor: ", error);
                 showMessage("Erro", `Não foi possível excluir o setor: ${error.message}`);
            } finally {
                closeModal(deleteConfirmModal);
                deleteCallback = null;
            }
        }
        
        // --- Funções de Abertura (Edição) ---
        
        // Delega eventos nas tabelas do Admin
        document.getElementById('view-admin').addEventListener('click', async (e) => {
            const target = e.target;
            
            // Editar Supervisor
            if (target.classList.contains('btn-edit-supervisor')) {
                const id = target.getAttribute('data-id');
                const docRef = doc(db, 'artifacts', appId, 'supervisors', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const sup = docSnap.data();
                    supervisorModalTitle.textContent = "Editar Supervisor";
                    document.getElementById('edit-supervisor-id').value = id;
                    document.getElementById('supervisor-name').value = sup.name;
                    document.getElementById('supervisor-sector').value = sup.sectorId;
                    document.getElementById('supervisor-username').value = sup.username;
                    // Senha é opcional na edição
                    document.getElementById('supervisor-password').value = '';
                    document.getElementById('supervisor-password').required = false; 
                    openModal(supervisorModal);
                }
            }
            
            // Excluir Supervisor
            if (target.classList.contains('btn-delete-supervisor')) {
                const id = target.getAttribute('data-id');
                const name = target.closest('tr').querySelector('td:first-child').textContent;
                openDeleteModal('supervisor', id, name);
            }
            
            // Excluir Setor
            if (target.classList.contains('btn-delete-sector')) {
                const id = target.getAttribute('data-id');
                const name = target.closest('tr').querySelector('td:first-child').textContent;
                openDeleteModal('sector', id, name);
            }
            
            // Editar Colaborador
            if (target.classList.contains('btn-edit-employee')) {
                const id = target.getAttribute('data-id');
                const docRef = doc(db, 'artifacts', appId, 'employees', id);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    const emp = docSnap.data();
                    employeeModalTitle.textContent = "Editar Colaborador";
                    document.getElementById('edit-employee-id').value = id;
                    document.getElementById('employee-name').value = emp.name;
                    document.getElementById('employee-sector').value = emp.sectorId;
                    
                    // Lógica para Supervisor (trava o setor)
                    if (isSupervisor && !isRhUser) {
                        employeeSectorSelect.disabled = true;
                    } else {
                        employeeSectorSelect.disabled = false;
                    }
                    
                    openModal(employeeModal);
                }
            }
            
            // Excluir Colaborador
            if (target.classList.contains('btn-delete-employee')) {
                const id = target.getAttribute('data-id');
                const name = target.closest('tr').querySelector('td:first-child').textContent;
                openDeleteModal('employee', id, name);
            }
        });

        
        // --- Funções de Salvamento (Formulários) ---
        
        // Salvar SUPERVISOR
        supervisorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-supervisor-id').value;
            const name = document.getElementById('supervisor-name').value;
            const sectorId = document.getElementById('supervisor-sector').value;
            const username = document.getElementById('supervisor-username').value;
            const password = document.getElementById('supervisor-password').value;
            
            if (!sectorId) {
                showMessage("Erro de Validação", "Por favor, selecione um setor.");
                return;
            }
            
            const sectorName = supervisorSectorSelect.options[supervisorSectorSelect.selectedIndex].text;
            
            // Validação de duplicados
            try {
                // 1. Verifica se o setor já está em uso (exceto por ele mesmo)
                const qSector = query(getSupervisorsCollection(), where("sectorId", "==", sectorId));
                const sectorSnapshot = await getDocs(qSector);
                if (!sectorSnapshot.empty) {
                    const existing = sectorSnapshot.docs[0];
                    if (existing.id !== id) { // Se achou um e NÃO é ele mesmo
                         showMessage("Erro de Validação", `O setor "${sectorName}" já está atribuído ao supervisor "${existing.data().name}".`);
                         return;
                    }
                }
                
                // 2. Verifica se o username já está em uso (exceto por ele mesmo)
                const qUser = query(getSupervisorsCollection(), where("username", "==", username));
                const userSnapshot = await getDocs(qUser);
                 if (!userSnapshot.empty) {
                    const existing = userSnapshot.docs[0];
                    if (existing.id !== id) {
                         showMessage("Erro de Validação", `O usuário "${username}" já está em uso.`);
                         return;
                    }
                }

                // 3. Prepara os dados
                let data = { name, sectorId, sectorName, username };
                if (password) { // Só atualiza a senha se ela for preenchida
                    data.password = password;
                }
                
                if (id) {
                    // Atualizar
                    const docRef = doc(db, 'artifacts', appId, 'supervisors', id);
                    await updateDoc(docRef, data);
                    showMessage("Sucesso", "Supervisor atualizado.");
                } else {
                    // Criar
                    if (!password) { // Senha é obrigatória na criação
                        showMessage("Erro de Validação", "O campo 'Senha' é obrigatório ao criar um novo supervisor.");
                        return;
                    }
                    await addDoc(getSupervisorsCollection(), data);
                    showMessage("Sucesso", "Supervisor cadastrado.");
                }
                
                closeModal(supervisorModal);
                
            } catch (error) {
                console.error("Erro ao salvar supervisor: ", error);
                showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            }
        });

        // Salvar SETOR (Master)
        sectorForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-sector-id').value; // Master não edita, mas deixamos por segurança
            const name = sectorNameInput.value;
            
            if (id) {
                 showMessage("Erro", "A edição de setor é feita pelo supervisor em 'Gerenciar Metas'.");
                 return;
            }

            // Validação de duplicados (Ignora case)
            try {
                const q = query(getSectorsCollection(), where("nameLower", "==", name.toLowerCase()));
                const snapshot = await getDocs(q);
                
                if (!snapshot.empty) {
                    showMessage("Erro de Validação", `O setor "${name}" já existe.`);
                    return;
                }
                
                const data = {
                    name: name,
                    nameLower: name.toLowerCase(), // Campo para busca
                    indices: [] // Master só cria o nome, supervisor define índices
                };
                
                await addDoc(getSectorsCollection(), data);
                showMessage("Sucesso", `Setor "${name}" cadastrado. O supervisor deste setor deve agora definir os índices.`);
                closeModal(sectorModal);

            } catch (error) {
                 console.error("Erro ao salvar setor: ", error);
                 showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            }
        });
        
        // Salvar METAS (Supervisor)
        indicesForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sectorId = document.getElementById('edit-indices-sector-id').value;
            
            const indicesInputs = indicesList.querySelectorAll('.indice-row');
            const newIndices = [];
            let total = 0;
            
            indicesInputs.forEach(row => {
                const name = row.querySelector('.indice-name').value;
                const percent = parseFloat(row.querySelector('.indice-percent').value) || 0;
                
                if (name && percent > 0) {
                    newIndices.push({ name, percent });
                    total += percent;
                }
            });
            
            if (total !== 100) {
                showMessage("Erro de Validação", `A soma dos índices deve ser exatamente 100%. O total atual é: ${total}%.`);
                return;
            }
            
            try {
                const docRef = doc(db, 'artifacts', appId, 'sectors', sectorId);
                await updateDoc(docRef, { indices: newIndices });
                
                showMessage("Sucesso", "Índices (metas) atualizados com sucesso!");
                closeModal(indicesModal);
                
                // Força o recarregamento dos índices na tela principal
                renderIndices(employeeSelect.value);

            } catch (error) {
                 console.error("Erro ao salvar índices: ", error);
                 showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            }
        });

        // Salvar COLABORADOR
        employeeForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('edit-employee-id').value;
            const name = document.getElementById('employee-name').value;
            const sectorId = document.getElementById('employee-sector').value;
            
            if (!sectorId) {
                showMessage("Erro de Validação", "Por favor, selecione um setor.");
                return;
            }
            
            const sectorName = employeeSectorSelect.options[employeeSectorSelect.selectedIndex].text;
            
            try {
                // Validação de duplicados
                const q = query(getEmployeesCollection(), where("name", "==", name));
                const snapshot = await getDocs(q);
                if (!snapshot.empty) {
                    const existing = snapshot.docs[0];
                    if (existing.id !== id) {
                         showMessage("Erro de Validação", `Um colaborador com o nome "${name}" já existe.`);
                         return;
                    }
                }
                
                const data = { name, sectorId, sectorName };
                
                if (id) {
                    // Atualizar
                    const docRef = doc(db, 'artifacts', appId, 'employees', id);
                    await updateDoc(docRef, data);
                    showMessage("Sucesso", "Colaborador atualizado.");
                } else {
                    // Criar
                    await addDoc(getEmployeesCollection(), data);
                    showMessage("Sucesso", "Colaborador cadastrado.");
                }
                
                closeModal(employeeModal);
                
            } catch (error) {
                 console.error("Erro ao salvar colaborador: ", error);
                 showMessage("Erro no Banco", `Não foi possível salvar: ${error.message}`);
            }
        });


        // --- Funções Auxiliares (Modal de Índices) ---
        
        // Adiciona uma linha de índice (nome/percentual) no modal
        function addIndiceRow(name = '', percent = '') {
            const div = document.createElement('div');
            div.className = 'indice-row flex gap-2 items-center';
            div.innerHTML = `
                <input type="text" class="indice-name mt-1 w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="Nome do Índice" value="${name}" required>
                <input type="number" class="indice-percent mt-1 w-24 px-3 py-2 border border-gray-300 rounded-md" placeholder="%" value="${percent}" required>
                <button type="button" class="btn-remove-indice text-red-500 hover:text-red-700 font-bold text-2xl">&times;</button>
            `;
            
            div.querySelector('.btn-remove-indice').addEventListener('click', () => {
                div.remove();
                updateIndicesTotal();
            });
            
            div.querySelector('.indice-percent').addEventListener('input', updateIndicesTotal);
            
            indicesList.appendChild(div);
        }
        
        btnAddIndice.addEventListener('click', () => addIndiceRow());
        
        // Calcula o total dos índices no modal
        function updateIndicesTotal() {
            let total = 0;
            indicesList.querySelectorAll('.indice-percent').forEach(input => {
                total += parseFloat(input.value) || 0;
            });
            indicesTotalPercent.textContent = `Total: ${total}%`;
            
            // Validação visual
            if (total === 100) {
                indicesTotalPercent.classList.remove('text-red-600');
                indicesTotalPercent.classList.add('text-green-600');
                btnSaveIndices.disabled = false;
            } else {
                indicesTotalPercent.classList.add('text-red-600');
                indicesTotalPercent.classList.remove('text-green-600');
                btnSaveIndices.disabled = true;
            }
        }
        
        // Mostrar/Esconder senha no modal de supervisor
        showPasswordSupervisor.addEventListener('change', () => {
            const passInput = document.getElementById('supervisor-password');
            passInput.type = showPasswordSupervisor.checked ? 'text' : 'password';
        });
        
        // --- Função de Exportação (CSV) ---
        
        btnDownloadCSV.addEventListener('click', () => {
            if (globalHistory.length === 0) {
                showMessage("Aviso", "Não há dados no histórico para exportar.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            
            // Cabeçalho Principal
            let headers = [
                "MesRef", "Colaborador", "Setor", "ValorBase", "ValorTotal", "LancadoEm"
            ];
            
            // Cabeçalhos Dinâmicos (Índices)
            // Pega todos os nomes de índices de todos os lançamentos
            const allIndicesNames = new Set();
            globalHistory.forEach(item => {
                item.scores.forEach(score => {
                    allIndicesNames.add(`Indice_${score.name.replace(/[^a-zA-Z0-9]/g, '')}`); // Nome limpo
                    allIndicesNames.add(`Score_${score.name.replace(/[^a-zA-Z0-9]/g, '')}`); // Nome limpo
                });
            });
            
            const dynamicHeaders = Array.from(allIndicesNames);
            headers = [...headers, ...dynamicHeaders];
            
            csvContent += headers.join(";") + "\r\n"; // Usa PONTO E VÍRGULA

            // Linhas
            globalHistory.forEach(item => {
                let row = [
                    item.monthRef,
                    item.employeeName,
                    item.sectorName,
                    item.baseValue.toFixed(2),
                    item.totalValue.toFixed(2),
                    item.createdAt ? item.createdAt.toDate().toLocaleString('pt-BR') : ''
                ];
                
                // Adiciona os valores dos índices dinâmicos
                const scoreMap = new Map();
                item.scores.forEach(score => {
                    scoreMap.set(`Indice_${score.name.replace(/[^a-zA-Z0-9]/g, '')}`, score.max);
                    scoreMap.set(`Score_${score.name.replace(/[^a-zA-Z0-9]/g, '')}`, score.score);
                });
                
                dynamicHeaders.forEach(headerName => {
                    row.push(scoreMap.get(headerName) || '0'); // Adiciona 0 se o índice não existir nesse lançamento
                });
                
                csvContent += row.join(";") + "\r\n"; // Usa PONTO E VÍRGULA
            });

            // Cria e baixa o arquivo
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `historico_remuneracao_${monthRefInput.value}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });


        // --- Inicialização da Aplicação ---
        // Garante que o DOM esteja carregado antes de tentar iniciar o Firebase
        // Correção: Apenas o `startFirebase` deve esperar o DOM.
        document.addEventListener("DOMContentLoaded", () => {
             // Inicia o Firebase assim que o DOM estiver pronto
             startFirebase();
        });

    </script>
</body>
</html>